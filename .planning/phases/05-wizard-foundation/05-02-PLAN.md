---
phase: 05-wizard-foundation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/ui/wizard.js
  - src/data/commune.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can enter 5-digit postal code"
    - "User sees matching commune(s) after entering valid postal code"
    - "User can select from multiple communes when >1 result"
    - "User sees error for invalid or non-existent postal codes"
  artifacts:
    - path: "src/data/commune.js"
      provides: "Postal code to commune lookup"
      exports: ["searchCommunesByPostalCode"]
      min_lines: 30
    - path: "src/ui/wizard.js"
      provides: "Postal step handler with API integration"
      contains: "searchCommunesByPostalCode"
  key_links:
    - from: "src/ui/wizard.js"
      to: "src/data/commune.js"
      via: "import and function call"
      pattern: "searchCommunesByPostalCode\\("
    - from: "src/data/commune.js"
      to: "geo.api.gouv.fr API"
      via: "fetch call"
      pattern: "geo\\.api\\.gouv\\.fr/communes"
---

<objective>
Implement postal code lookup with multi-commune selection handling.

Purpose: Enable users to search for their commune by postal code and handle cases where multiple communes share the same postal code, completing the core data collection step of the wizard.

Output: Working postal code input with API-driven commune lookup, automatic single-result handling, and radio button selection UI for multiple results.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wizard-foundation/05-RESEARCH.md
@.planning/phases/05-wizard-foundation/05-01-SUMMARY.md

# Existing API patterns
@src/data/commune.js
@src/services/geocoding.js
</context>

<tasks>

<task type="auto">
  <name>Add searchCommunesByPostalCode to commune.js</name>
  <files>src/data/commune.js</files>
  <action>
Add searchCommunesByPostalCode function to src/data/commune.js following the exact pattern from 05-RESEARCH.md (lines 585-622).

Export async function searchCommunesByPostalCode(postalCode) that:
1. Constructs URL with required parameters:
   - Base: `https://geo.api.gouv.fr/communes`
   - Query params: `codePostal={postalCode}&fields=nom,code,codesPostaux,contour&format=json&geometry=contour`
   - IMPORTANT: Include `geometry=contour` to get boundary GeoJSON (pitfall #4 from research)
2. Fetches with GET request, Accept: application/json header
3. Validates response is Array (API always returns array, even for single result)
4. Validates each commune has required fields (code, nom)
5. Logs warning if commune missing contour geometry
6. Returns communes array
7. Throws error on HTTP failure or invalid response format

Use try-catch pattern consistent with existing fetchCommuneBoundary() in same file.

Add JSDoc comment with:
- @param {string} postalCode - 5-digit postal code
- @returns {Promise<Array>} Array of commune objects with contour GeoJSON
- @throws {Error} If API request fails or returns invalid data

Do NOT implement retry logic (research notes it's defensive but not required for MVP).
  </action>
  <verify>
Check src/data/commune.js exports searchCommunesByPostalCode.
Verify function signature matches: `export async function searchCommunesByPostalCode(postalCode)`.
Verify URL includes `geometry=contour` parameter.
Run `grep "geometry=contour" src/data/commune.js` - should return match.
  </verify>
  <done>
src/data/commune.js exports searchCommunesByPostalCode function.
Function fetches from geo.api.gouv.fr with geometry=contour parameter.
Returns array of commune objects with validation.
  </done>
</task>

<task type="auto">
  <name>Implement postal step with multi-commune handling</name>
  <files>src/ui/wizard.js, index.html</files>
  <action>
Update index.html postal step (data-step-name="postal") to replace placeholder content with:
```html
<div class="wz-step" data-step-name="postal">
  <h3>Votre code postal</h3>
  <div class="form-field">
    <label for="postal-code">Code postal (5 chiffres)</label>
    <input type="text" id="postal-code" name="postalCode" pattern="[0-9]{5}" maxlength="5" required placeholder="78130">
  </div>
  <div id="commune-results"></div>
  <button class="wz-next-button btn-primary" disabled>Suivant</button>
</div>
```

Update src/ui/wizard.js to implement postal step handler following research pattern (lines 430-503).

Add module-scoped variable:
```javascript
let selectedCommune = null;
```

Create setupPostalStep() function that:
1. Gets input, next button, and results container elements
2. Disables next button initially
3. Adds blur event listener to input that calls handlePostalCodeLookup
4. Adds keydown listener for Enter key that prevents default and calls handlePostalCodeLookup

Implement handlePostalCodeLookup async function that:
1. Validates postal code format with regex: `/^[0-9]{5}$/`
2. Shows error in results container if invalid: `<p class="error">Code postal invalide (5 chiffres requis)</p>`
3. Shows loading state: `<p>Recherche...</p>`
4. Calls searchCommunesByPostalCode(postalCode) from commune.js
5. Handles empty results: `<p class="error">Aucune commune trouvée</p>`
6. If length === 1: auto-selects commune, shows success message, enables next button
7. If length > 1: calls renderCommuneSelection(communes)
8. Catches errors and shows: `<p class="error">Erreur de connexion à l'API</p>`

Implement renderCommuneSelection(communes) function that:
1. Renders radio buttons for each commune:
   ```html
   <p>Plusieurs communes trouvées:</p>
   <label class="commune-option">
     <input type="radio" name="commune" value="{code}" required>
     {nom} ({code})
   </label>
   ```
2. Adds change event listener to container
3. On radio selection: finds matching commune, sets selectedCommune, enables next button

Call setupPostalStep() from initWelcomeWizard() after setupWelcomeStep().

Import searchCommunesByPostalCode at top of wizard.js:
```javascript
import { searchCommunesByPostalCode } from '../data/commune.js';
```

Do NOT implement sessionStorage yet (deferred to Plan 3).
Do NOT implement boundary preview yet (that's Plan 3).
  </action>
  <verify>
Verify index.html postal step contains input#postal-code with pattern="[0-9]{5}".
Verify src/ui/wizard.js imports searchCommunesByPostalCode.
Verify setupPostalStep function exists and is called from initWelcomeWizard.
Check for handlePostalCodeLookup and renderCommuneSelection functions.
Run `grep "selectedCommune" src/ui/wizard.js` - should find module variable.
  </verify>
  <done>
Postal code input accepts 5-digit codes with HTML5 validation.
Lookup triggers on blur or Enter key.
Single commune result auto-selects and enables next button.
Multiple commune results show radio button selection UI.
Invalid codes show error messages.
selectedCommune variable populated on selection.
  </done>
</task>

</tasks>

<verification>
Run `npm run dev` and open browser console.
Call `initWelcomeWizard()`.

Test cases:
1. **Single commune:** Enter "78130" (Chapet) → should auto-select and enable "Suivant"
2. **Multiple communes:** Enter "75001" (4 Paris arrondissements) → should show 4 radio options
3. **Invalid format:** Enter "1234" → should show "Code postal invalide"
4. **Non-existent:** Enter "99999" → should show "Aucune commune trouvée"
5. **Selection:** For multi-result, select radio → should enable "Suivant" button

Verify clicking "Suivant" advances to step 3 (preview placeholder).
</verification>

<success_criteria>
- src/data/commune.js exports searchCommunesByPostalCode function
- Function fetches from geo.api.gouv.fr with geometry=contour parameter
- Postal step input validates 5-digit format
- Single commune results auto-select
- Multiple commune results show radio selection UI
- Invalid/non-existent codes show error messages
- selectedCommune variable populated on selection
- Next button enabled only after valid selection
</success_criteria>

<output>
After completion, create `.planning/phases/05-wizard-foundation/05-02-SUMMARY.md`
</output>
