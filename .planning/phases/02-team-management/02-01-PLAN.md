---
phase: 02-team-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/storage.js
  - src/state/store.js
  - src/map/markerStyles.js
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "Team member data survives browser refresh"
    - "Storage failures are caught and reported, not silent"
    - "Each team member has a distinct color"
  artifacts:
    - path: "src/data/storage.js"
      provides: "LocalStorage wrapper with try-catch and quota monitoring"
      exports: ["Storage"]
    - path: "src/state/store.js"
      provides: "PubSub state manager for team members"
      exports: ["store", "subscribe"]
    - path: "src/map/markerStyles.js"
      provides: "Colored DivIcon marker factory"
      exports: ["createColoredMarker", "getTeamMemberColor"]
  key_links:
    - from: "src/state/store.js"
      to: "src/data/storage.js"
      via: "debounced persistence on state change"
      pattern: "storage\\.save|debouncedSave"
---

<objective>
Build the core infrastructure layer for team management: defensive LocalStorage wrapper, PubSub state manager with debounced persistence, and colored marker styling.

Purpose: These utilities are foundational - the state store will coordinate all team member operations, storage ensures data persistence, and marker styles enable visual distinction between team members.

Output: Three reusable modules ready for the data services and UI layers.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-RESEARCH.md
@src/main.js
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create defensive LocalStorage wrapper</name>
  <files>src/data/storage.js</files>
  <action>
Create a Storage class that wraps all localStorage operations in try-catch blocks.

Requirements:
1. `save(key, data)` - JSON.stringify data, catch QuotaExceededError (code 22 or 1014), return `{success: boolean, error?: string}`
2. `load(key)` - JSON.parse with try-catch, return null on failure
3. `remove(key)` - Remove key with try-catch
4. `isNearQuota(newData)` - Calculate used storage, warn at >80% of 5MB quota
5. Export a singleton instance as default

Key implementation detail from research:
- QuotaExceededError has code 22 (most browsers) or 1014 (Firefox)
- Private browsing mode blocks localStorage completely - must handle gracefully
- Calculate used storage by iterating all keys and summing `(key.length + value.length) * 2` (UTF-16)

Example structure:
```javascript
class Storage {
  save(key, data) {
    try {
      const serialized = JSON.stringify(data);
      if (this.isNearQuota(serialized)) {
        console.warn('LocalStorage approaching quota limit');
      }
      localStorage.setItem(key, serialized);
      return { success: true };
    } catch (error) {
      if (error.code === 22 || error.code === 1014 || error.name === 'QuotaExceededError') {
        return { success: false, error: 'QUOTA_EXCEEDED' };
      }
      return { success: false, error: 'STORAGE_FAILED' };
    }
  }
  // ... load, remove, isNearQuota
}
export default new Storage();
```
  </action>
  <verify>
In browser console:
```javascript
import storage from './src/data/storage.js';
storage.save('test', {a: 1}); // {success: true}
storage.load('test'); // {a: 1}
storage.remove('test');
storage.load('test'); // null
```
  </verify>
  <done>Storage wrapper saves/loads JSON data with error handling, returns success status on save</done>
</task>

<task type="auto">
  <name>Task 2: Create PubSub state manager with debounced persistence</name>
  <files>src/state/store.js</files>
  <action>
Create a state manager for team members using PubSub pattern with automatic debounced persistence to LocalStorage.

Requirements:
1. PubSub class with `subscribe(event, callback)` and `publish(event, data)` methods
2. Store class that:
   - Holds `teamMembers` array in state
   - Loads initial state from localStorage on construction (key: 'vivons_chapet_team')
   - Provides `getTeamMembers()`, `addTeamMember(member)`, `removeTeamMember(id)`, `updateTeamMember(id, updates)`
   - Auto-generates unique ID for new members: `Date.now().toString(36) + Math.random().toString(36).substr(2)`
   - Publishes events: 'teamMemberAdded', 'teamMemberRemoved', 'teamMemberUpdated', 'teamMembersLoaded'
   - Debounces persistence (500ms delay) to avoid thrashing localStorage
   - Provides `subscribe(event, callback)` method to listen for changes

Import storage from `../data/storage.js`.

Structure:
```javascript
import storage from '../data/storage.js';

const STORAGE_KEY = 'vivons_chapet_team';
const DEBOUNCE_MS = 500;

class PubSub { /* ... */ }

class Store {
  constructor() {
    this.pubsub = new PubSub();
    this.state = { teamMembers: [] };
    this.saveTimer = null;
    this._loadInitialState();
  }
  // Methods...
}

export const store = new Store();
export const subscribe = (event, callback) => store.subscribe(event, callback);
```
  </action>
  <verify>
In browser console:
```javascript
import { store, subscribe } from './src/state/store.js';
subscribe('teamMemberAdded', (m) => console.log('Added:', m));
store.addTeamMember({name: 'Test', address: '1 rue Test'});
store.getTeamMembers(); // [{id: '...', name: 'Test', ...}]
// Refresh page, check data persists
```
  </verify>
  <done>State manager holds team members array, persists to localStorage on change (debounced), emits events on mutations</done>
</task>

<task type="auto">
  <name>Task 3: Create colored marker styles with DivIcon</name>
  <files>src/map/markerStyles.js, src/style.css</files>
  <action>
Create colored marker factory using Leaflet's DivIcon (no image files needed).

In src/map/markerStyles.js:
1. Define color palette (8 distinct colors for team members):
   ```javascript
   const COLORS = [
     '#c30b82', // magenta
     '#2563eb', // blue
     '#16a34a', // green
     '#ea580c', // orange
     '#7c3aed', // purple
     '#0891b2', // cyan
     '#dc2626', // red
     '#ca8a04'  // yellow
   ];
   ```
2. `getTeamMemberColor(index)` - Returns color from palette (cycles if > 8 members)
3. `createColoredMarker(color, label)` - Returns L.divIcon with:
   - CSS class 'custom-div-icon'
   - HTML: marker-pin div with background-color, marker-label div with truncated name
   - iconSize: [30, 42]
   - iconAnchor: [15, 42] (bottom center)
   - popupAnchor: [0, -42] (above marker)

In src/style.css, ADD marker styles (don't replace existing):
```css
/* Team member markers */
.custom-div-icon {
  background: transparent;
  border: none;
}

.marker-pin {
  width: 30px;
  height: 30px;
  border-radius: 50% 50% 50% 0;
  position: absolute;
  transform: rotate(-45deg);
  left: 50%;
  top: 50%;
  margin: -15px 0 0 -15px;
}

.marker-pin::after {
  content: '';
  width: 24px;
  height: 24px;
  margin: 3px 0 0 3px;
  background: #fff;
  position: absolute;
  border-radius: 50%;
}

.marker-label {
  position: absolute;
  top: 35px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 10px;
  white-space: nowrap;
  background: rgba(255,255,255,0.8);
  padding: 1px 4px;
  border-radius: 2px;
  max-width: 60px;
  overflow: hidden;
  text-overflow: ellipsis;
}
```

Note: Must import L from 'leaflet' in markerStyles.js.
  </action>
  <verify>
In browser console with map running:
```javascript
import L from 'leaflet';
import { createColoredMarker, getTeamMemberColor } from './src/map/markerStyles.js';
const icon = createColoredMarker(getTeamMemberColor(0), 'Jean');
L.marker([48.969, 1.932], {icon}).addTo(map);
// Visual check: magenta pin-shaped marker with "Jean" label appears on map
```
  </verify>
  <done>Colored DivIcon markers render as pin shapes with team member colors and name labels</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Storage module exports default Storage instance with save/load/remove methods
2. Store module exports store and subscribe, manages teamMembers array
3. MarkerStyles module exports createColoredMarker and getTeamMemberColor
4. CSS includes .marker-pin and .marker-label styles
5. Data persists across page refresh (via store -> storage integration)
</verification>

<success_criteria>
- Storage wrapper handles localStorage errors gracefully (returns success: false, not throws)
- State store persists team members automatically with debounce
- Colored markers display as pin shapes with distinct team colors
- All modules export correctly and can be imported
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-01-SUMMARY.md`
</output>
