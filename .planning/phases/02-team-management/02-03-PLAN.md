---
phase: 02-team-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/map/markerLayer.js
  - src/ui/sidePanel.js
  - src/ui/importFlow.js
  - src/main.js
  - src/style.css
  - index.html
autonomous: false

must_haves:
  truths:
    - "User can import team members from CSV file"
    - "Imported team members appear as colored markers on map"
    - "Clicking a marker shows team member details (name, address, phone)"
    - "Side panel displays list of all team members with colors"
    - "Team data persists across browser sessions"
  artifacts:
    - path: "src/map/markerLayer.js"
      provides: "FeatureGroup marker management"
      exports: ["markerLayer", "addMemberMarker", "removeMemberMarker", "clearMarkers"]
    - path: "src/ui/sidePanel.js"
      provides: "Team list side panel"
      exports: ["initSidePanel", "updateTeamList"]
    - path: "src/ui/importFlow.js"
      provides: "CSV import orchestration"
      exports: ["handleFileImport"]
    - path: "src/main.js"
      provides: "Application initialization wiring"
    - path: "index.html"
      provides: "Import button and side panel container"
  key_links:
    - from: "src/ui/importFlow.js"
      to: "src/services/csvImport.js"
      via: "parseCSV call"
      pattern: "parseCSV\\(file\\)"
    - from: "src/ui/importFlow.js"
      to: "src/services/geocoding.js"
      via: "geocodeBatch call"
      pattern: "geocodeBatch\\("
    - from: "src/ui/importFlow.js"
      to: "src/state/store.js"
      via: "addTeamMember call"
      pattern: "store\\.addTeamMember"
    - from: "src/map/markerLayer.js"
      to: "src/state/store.js"
      via: "subscribe to state changes"
      pattern: "subscribe\\("
    - from: "src/ui/sidePanel.js"
      to: "src/state/store.js"
      via: "subscribe to state changes"
      pattern: "subscribe\\("
---

<objective>
Wire together all Phase 2 components: marker layer on map, side panel with team list, and complete CSV import flow.

Purpose: This plan integrates the infrastructure (Plan 01) and services (Plan 02) into a working feature. Users will be able to import a CSV, see team members geocoded on the map, view details via popups, and browse the team list in a side panel.

Output: Complete Phase 2 feature - team management with persistence.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-RESEARCH.md
@.planning/phases/02-team-management/02-01-SUMMARY.md
@.planning/phases/02-team-management/02-02-SUMMARY.md
@src/main.js
@src/style.css
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create marker layer with FeatureGroup and popup support</name>
  <files>src/map/markerLayer.js</files>
  <action>
Create marker layer management using Leaflet FeatureGroup for efficient add/remove.

Requirements:
1. Initialize with reference to Leaflet map instance
2. Use FeatureGroup to manage all team member markers
3. Track markers by member ID using Map()
4. Subscribe to store events to auto-update markers

Functions:
- `initMarkerLayer(map)` - Initialize with map, subscribe to store events
- `addMemberMarker(member)` - Create marker with colored icon and popup, add to layer
- `removeMemberMarker(memberId)` - Remove marker from layer
- `clearMarkers()` - Remove all markers
- `getMarkerCount()` - Return number of markers

Popup content (from TEAM-03):
```html
<div class="member-popup">
  <h3>{member.name}</h3>
  <p><strong>Adresse:</strong><br>{member.address}</p>
  {if member.phone: <p><strong>Téléphone:</strong><br>{member.phone}</p>}
</div>
```

Auto-sync with store:
- On 'teamMemberAdded': addMemberMarker(member)
- On 'teamMemberRemoved': removeMemberMarker(memberId)
- On 'teamMembersLoaded': clear all, then add all existing members

Import from Plan 01: createColoredMarker, getTeamMemberColor from markerStyles.js
Import from Plan 01: store, subscribe from state/store.js

Example:
```javascript
import L from 'leaflet';
import { createColoredMarker, getTeamMemberColor } from './markerStyles.js';
import { store, subscribe } from '../state/store.js';

let map = null;
let featureGroup = null;
const markersByMemberId = new Map();

export function initMarkerLayer(mapInstance) {
  map = mapInstance;
  featureGroup = L.featureGroup().addTo(map);

  // Load existing members
  const members = store.getTeamMembers();
  members.forEach((member, index) => {
    addMemberMarker(member, index);
  });

  // Subscribe to future changes
  subscribe('teamMemberAdded', (member) => {
    const index = store.getTeamMembers().indexOf(member);
    addMemberMarker(member, index);
  });

  subscribe('teamMemberRemoved', ({ memberId }) => {
    removeMemberMarker(memberId);
  });
}

export function addMemberMarker(member, colorIndex) {
  const color = getTeamMemberColor(colorIndex);
  const icon = createColoredMarker(color, member.name);
  const marker = L.marker([member.lat, member.lng], { icon });

  marker.bindPopup(`
    <div class="member-popup">
      <h3>${member.name}</h3>
      <p><strong>Adresse:</strong><br>${member.address}</p>
      ${member.phone ? `<p><strong>Téléphone:</strong><br>${member.phone}</p>` : ''}
    </div>
  `);

  featureGroup.addLayer(marker);
  markersByMemberId.set(member.id, marker);
}

// ... removeMemberMarker, clearMarkers, getMarkerCount
```
  </action>
  <verify>
After import flow works (Task 3), verify:
- Markers appear at correct locations
- Clicking marker shows popup with name, address, phone
- Markers have distinct colors
  </verify>
  <done>Markers auto-sync with store, display colored pins with popups showing member details</done>
</task>

<task type="auto">
  <name>Task 2: Create side panel with team list</name>
  <files>src/ui/sidePanel.js, src/style.css, index.html</files>
  <action>
Create a side panel showing the team member list with color indicators.

In index.html, ADD side panel container and import button (don't replace existing):
```html
<!-- Before closing body tag, add: -->
<div id="side-panel" class="side-panel">
  <div class="panel-header">
    <h2>Équipe</h2>
    <label class="import-btn">
      Importer CSV
      <input type="file" id="csv-import" accept=".csv" hidden>
    </label>
  </div>
  <div id="team-list" class="team-list">
    <p class="empty-message">Aucun colistier importé</p>
  </div>
</div>
```

In src/style.css, ADD panel styles:
```css
/* Side panel */
.side-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 280px;
  height: 100vh;
  background: white;
  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
  z-index: 1000;
  display: flex;
  flex-direction: column;
}

.panel-header {
  padding: 16px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-header h2 {
  margin: 0;
  font-size: 18px;
}

.import-btn {
  background: #2563eb;
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.import-btn:hover {
  background: #1d4ed8;
}

.team-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.empty-message {
  color: #6b7280;
  text-align: center;
  padding: 20px;
}

.team-member-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  background: #f9fafb;
}

.team-member-item:hover {
  background: #f3f4f6;
}

.color-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 10px;
  flex-shrink: 0;
}

.member-info {
  flex: 1;
  min-width: 0;
}

.member-name {
  font-weight: 500;
  margin: 0 0 2px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.member-address {
  font-size: 12px;
  color: #6b7280;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Adjust map to make room for panel */
#map {
  width: calc(100% - 280px);
}
```

In src/ui/sidePanel.js:
```javascript
import { store, subscribe } from '../state/store.js';
import { getTeamMemberColor } from '../map/markerStyles.js';

export function initSidePanel() {
  updateTeamList();

  subscribe('teamMemberAdded', updateTeamList);
  subscribe('teamMemberRemoved', updateTeamList);
  subscribe('teamMembersLoaded', updateTeamList);
}

export function updateTeamList() {
  const container = document.getElementById('team-list');
  const members = store.getTeamMembers();

  if (members.length === 0) {
    container.innerHTML = '<p class="empty-message">Aucun colistier importé</p>';
    return;
  }

  container.innerHTML = members.map((member, index) => `
    <div class="team-member-item" data-id="${member.id}">
      <div class="color-dot" style="background-color: ${getTeamMemberColor(index)}"></div>
      <div class="member-info">
        <p class="member-name">${member.name}</p>
        <p class="member-address">${member.address}</p>
      </div>
    </div>
  `).join('');
}
```
  </action>
  <verify>
Visual check:
- Side panel visible on right side
- "Équipe" header with "Importer CSV" button
- "Aucun colistier importé" message when empty
- After import: list shows members with colored dots and names
  </verify>
  <done>Side panel displays team member list with color coding, auto-updates when members are added/removed</done>
</task>

<task type="auto">
  <name>Task 3: Create import flow and wire main.js</name>
  <files>src/ui/importFlow.js, src/main.js</files>
  <action>
Create the import orchestration and wire everything in main.js.

In src/ui/importFlow.js:
```javascript
import { parseCSV, validateTeamMembers, normalizeTeamMember } from '../services/csvImport.js';
import { geocodeBatch } from '../services/geocoding.js';
import { store } from '../state/store.js';

export async function handleFileImport(file) {
  try {
    // Step 1: Parse CSV
    const rawMembers = await parseCSV(file);

    // Step 2: Validate
    const errors = validateTeamMembers(rawMembers);
    if (errors.length > 0) {
      const errorMsg = errors.map(e => `Ligne ${e.row}: ${e.message}`).join('\n');
      alert(`Erreurs de validation:\n${errorMsg}`);
      return { success: false, errors };
    }

    // Step 3: Normalize
    const members = rawMembers.map(normalizeTeamMember);

    // Step 4: Geocode
    const addresses = members.map(m => ({
      address: m.address,
      postcode: m.postcode || '78130' // Default to Chapet
    }));

    // Show progress
    const statusEl = document.getElementById('team-list');
    const originalContent = statusEl.innerHTML;
    statusEl.innerHTML = '<p class="empty-message">Géocodage en cours...</p>';

    const geoResults = await geocodeBatch(addresses);

    // Step 5: Merge results and add to store
    let successCount = 0;
    let failCount = 0;

    members.forEach((member, i) => {
      const geo = geoResults[i];
      if (geo.success) {
        store.addTeamMember({
          name: member.name,
          address: member.address,
          phone: member.phone || null,
          lat: geo.lat,
          lng: geo.lng,
          geocodeScore: geo.score
        });
        successCount++;
      } else {
        console.warn(`Geocoding failed for ${member.name}: ${geo.error}`);
        failCount++;
      }
    });

    // Step 6: Report results
    if (failCount > 0) {
      alert(`Import terminé: ${successCount} colistiers ajoutés, ${failCount} adresses non trouvées.`);
    }

    return { success: true, added: successCount, failed: failCount };

  } catch (error) {
    console.error('Import failed:', error);
    alert(`Erreur d'import: ${error.message || 'Erreur inconnue'}`);
    return { success: false, error };
  }
}

export function initImportHandler() {
  const input = document.getElementById('csv-import');
  if (input) {
    input.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        await handleFileImport(file);
        // Reset input to allow re-importing same file
        input.value = '';
      }
    });
  }
}
```

In src/main.js, ADD imports and initialization (keep existing map code):
```javascript
// ... existing imports ...
import { initMarkerLayer } from './map/markerLayer.js';
import { initSidePanel } from './ui/sidePanel.js';
import { initImportHandler } from './ui/importFlow.js';

// ... existing map initialization code ...

// Initialize Phase 2 features
initMarkerLayer(map);
initSidePanel();
initImportHandler();
```

Note: The map variable needs to be accessible. If it's in a closure, either:
- Export it: `export const map = L.map(...)`
- Or move initialization after map is created
  </action>
  <verify>
Full integration test:
1. Create test CSV file: `nom,adresse,telephone\nJean Dupont,1 rue de la Mairie 78130 Chapet,0612345678\nMarie Martin,Place de l'Église 78130 Chapet,`
2. Click "Importer CSV" button
3. Select the CSV file
4. Wait for "Géocodage en cours..." message
5. Verify markers appear on map (2 markers near Chapet center)
6. Click marker -> popup shows name, address, phone
7. Side panel shows 2 members with colored dots
8. Refresh page -> data still there (persisted)
  </verify>
  <done>Complete import flow: CSV -> validation -> geocoding -> store -> markers + side panel updated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 Team Management feature: CSV import with geocoding, colored markers with popups, side panel with team list, LocalStorage persistence</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173 in browser
3. Create a test CSV file with content:
   ```
   nom,adresse,telephone
   Jean Dupont,1 rue de la Mairie 78130 Chapet,0612345678
   Marie Martin,Place de l'Église 78130 Chapet,
   Pierre Durand,15 rue des Vignes 78130 Chapet,0698765432
   ```
4. Click "Importer CSV" button in side panel
5. Select the test CSV file
6. Verify:
   - [ ] Markers appear on map at correct Chapet locations
   - [ ] Each marker has a different color (magenta, blue, green)
   - [ ] Clicking a marker shows popup with name, address, phone (if provided)
   - [ ] Side panel shows all 3 team members with matching colored dots
   - [ ] Refresh the page - team members are still there (persistence works)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 Success Criteria (from ROADMAP.md):
1. ✓ User can import team members from CSV file and see them geocoded on the map
2. ✓ Each team member displays as a colored marker on the map
3. ✓ User can click a marker to see team member details (name, address, phone)
4. ✓ User can view the complete team list in a side panel with color coding
5. ✓ Team member data persists across browser sessions via LocalStorage
</verification>

<success_criteria>
- CSV import button triggers file selection
- Valid CSV files are parsed and geocoded
- Invalid files show validation errors to user
- Markers appear at geocoded coordinates
- Popups show member details
- Side panel list updates in sync with markers
- Data survives page refresh
</success_criteria>

<output>
After completion and checkpoint approval, create `.planning/phases/02-team-management/02-03-SUMMARY.md`
</output>
