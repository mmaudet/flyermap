---
phase: 08-zone-export
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - index.html
  - src/ui/zoneEditor.js
  - src/styles/main.css
autonomous: false

must_haves:
  truths:
    - "User can export zone as PDF from zone editor"
    - "User can export zone as CSV from zone editor"
    - "User sees loading indicator during export"
  artifacts:
    - path: "index.html"
      provides: "Export buttons in zone editor dialog"
      contains: "export-pdf-btn"
    - path: "src/ui/zoneEditor.js"
      provides: "Export button handlers with loading state"
      exports: ["initZoneEditor", "openZoneEditor"]
    - path: "src/styles/main.css"
      provides: "Export loading indicator styles"
      contains: "export-status"
  key_links:
    - from: "src/ui/zoneEditor.js"
      to: "src/services/zoneExport.js"
      via: "exportZonePDF/CSV import"
      pattern: "import.*exportZone.*from.*zoneExport"
---

<objective>
Add export UI to zone editor: PDF and CSV buttons with loading indicators.

Purpose: User-facing export feature - buttons in zone editor to trigger PDF/CSV generation with visual feedback.
Output: Export buttons in zone editor dialog, loading state during export, functional end-to-end export.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-zone-export/08-RESEARCH.md
@.planning/phases/08-zone-export/08-02-SUMMARY.md

@index.html
@src/ui/zoneEditor.js
@src/styles/main.css
@src/services/zoneExport.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export buttons to zone editor HTML and CSS</name>
  <files>
    index.html
    src/styles/main.css
  </files>
  <action>
1. Update index.html zone-editor dialog:
   Add export section before the button-row div:

   ```html
   <div class="export-section">
     <label>Exporter la zone</label>
     <div class="export-buttons">
       <button type="button" id="export-pdf-btn" class="btn-export">
         PDF
       </button>
       <button type="button" id="export-csv-btn" class="btn-export">
         CSV
       </button>
     </div>
     <small id="export-status"></small>
   </div>
   ```

2. Add CSS styles in src/styles/main.css:

   .export-section {
     margin: 1rem 0;
     padding-top: 1rem;
     border-top: 1px solid #e5e5e5;
   }

   .export-section > label {
     display: block;
     font-weight: 500;
     margin-bottom: 0.5rem;
   }

   .export-buttons {
     display: flex;
     gap: 0.5rem;
   }

   .btn-export {
     flex: 1;
     padding: 0.5rem 1rem;
     background: #f5f5f5;
     border: 1px solid #ddd;
     border-radius: 4px;
     cursor: pointer;
     font-size: 0.875rem;
   }

   .btn-export:hover:not(:disabled) {
     background: #e8e8e8;
   }

   .btn-export:disabled {
     opacity: 0.5;
     cursor: not-allowed;
   }

   #export-status {
     display: block;
     margin-top: 0.5rem;
     font-size: 0.75rem;
     color: #666;
   }

   #export-status.error {
     color: #c0392b;
   }

   #export-status.success {
     color: #27ae60;
   }
  </action>
  <verify>
    grep -q "export-pdf-btn" index.html
    grep -q "export-csv-btn" index.html
    grep -q ".btn-export" src/styles/main.css
  </verify>
  <done>
    Zone editor has Export PDF and Export CSV buttons with appropriate styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire export buttons to zoneExport service</name>
  <files>
    src/ui/zoneEditor.js
  </files>
  <action>
1. Import export functions at top of zoneEditor.js:
   import { exportZonePDF, exportZoneCSV } from '../services/zoneExport.js';
   import { getStreetsInBbox } from '../services/overpass.js';

2. Add global variable to store map reference:
   let mapInstance = null;

3. Export initZoneEditor to accept map parameter:
   export function initZoneEditor(map) {
     mapInstance = map;
     // ... existing init code
   }

4. In initZoneEditor, add export button handlers:

   const exportPdfBtn = document.getElementById('export-pdf-btn');
   const exportCsvBtn = document.getElementById('export-csv-btn');
   const exportStatus = document.getElementById('export-status');

   exportPdfBtn.addEventListener('click', () => handleExportPDF());
   exportCsvBtn.addEventListener('click', () => handleExportCSV());

5. Create handleExportPDF function:

   async function handleExportPDF() {
     if (!currentZone || !mapInstance) return;

     const exportPdfBtn = document.getElementById('export-pdf-btn');
     const exportCsvBtn = document.getElementById('export-csv-btn');
     const exportStatus = document.getElementById('export-status');

     try {
       exportPdfBtn.disabled = true;
       exportCsvBtn.disabled = true;
       exportStatus.className = '';

       await exportZonePDF(currentZone, mapInstance, (message) => {
         exportStatus.textContent = message;
       });

       exportStatus.textContent = 'PDF telecharge';
       exportStatus.className = 'success';
     } catch (error) {
       console.error('PDF export failed:', error);
       exportStatus.textContent = 'Erreur: ' + error.message;
       exportStatus.className = 'error';
     } finally {
       exportPdfBtn.disabled = false;
       exportCsvBtn.disabled = false;
     }
   }

6. Create handleExportCSV function:

   async function handleExportCSV() {
     if (!currentZone) return;

     const exportPdfBtn = document.getElementById('export-pdf-btn');
     const exportCsvBtn = document.getElementById('export-csv-btn');
     const exportStatus = document.getElementById('export-status');

     try {
       exportPdfBtn.disabled = true;
       exportCsvBtn.disabled = true;
       exportStatus.textContent = 'Recuperation des rues...';
       exportStatus.className = '';

       const streets = await getStreetsInBbox(currentZone.geojson);
       exportZoneCSV(currentZone, streets);

       exportStatus.textContent = 'CSV telecharge';
       exportStatus.className = 'success';
     } catch (error) {
       console.error('CSV export failed:', error);
       exportStatus.textContent = 'Erreur: ' + error.message;
       exportStatus.className = 'error';
     } finally {
       exportPdfBtn.disabled = false;
       exportCsvBtn.disabled = false;
     }
   }

7. Clear export status in dialog close handler (add after existing reset):
   document.getElementById('export-status').textContent = '';

8. Update main.js to pass map to initZoneEditor:
   - This may require checking where initZoneEditor is called and passing the map instance
  </action>
  <verify>
    npm run build succeeds
    grep -q "exportZonePDF" src/ui/zoneEditor.js
    grep -q "exportZoneCSV" src/ui/zoneEditor.js
  </verify>
  <done>
    Export buttons trigger PDF/CSV generation with loading states and error handling
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete zone export feature: PDF and CSV export buttons in zone editor dialog
    - PDF includes zone name, assigned team members, map screenshot, and OSM street list
    - CSV includes zone name, streets, and assigned members
    - Loading indicator shows progress during export
  </what-built>
  <how-to-verify>
    1. Run npm run dev
    2. Create or select an existing zone
    3. Click on the zone to open the zone editor
    4. Verify "Export PDF" and "Export CSV" buttons appear
    5. Click "Export PDF":
       - Should see loading messages: "Recuperation des rues...", "Capture de la carte...", "Generation du PDF..."
       - PDF should download with zone name, members, map image, street list
    6. Click "Export CSV":
       - Should see "Recuperation des rues..." then download
       - CSV should open correctly in Excel with French characters
    7. Test error handling: try exporting while offline (should show error message)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. npm run dev - app loads without errors
2. Zone editor shows Export PDF and Export CSV buttons
3. PDF export generates valid PDF with all required content
4. CSV export generates valid CSV with UTF-8 BOM
5. Loading indicators show during export
6. Errors display gracefully
</verification>

<success_criteria>
- EXP-01: User can export any zone as PDF from zone editor
- EXP-02: PDF includes zone name and assigned team members
- EXP-03: PDF includes visual map of zone boundary
- EXP-04: PDF includes list of streets from OpenStreetMap within zone
- EXP-05: User can export zone as CSV with structured data
- EXP-06: User sees loading indicator while OSM streets are being fetched
</success_criteria>

<output>
After completion, create `.planning/phases/08-zone-export/08-03-SUMMARY.md`
</output>
