---
phase: 08-zone-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/services/overpass.js
  - src/utils/mapCapture.js
autonomous: true

must_haves:
  truths:
    - "Streets can be fetched for any zone via Overpass API"
    - "Map can be captured as image blob for any zone"
  artifacts:
    - path: "src/services/overpass.js"
      provides: "getStreetsInBbox function"
      exports: ["countBuildingsDetailed", "getStreetsInBbox"]
    - path: "src/utils/mapCapture.js"
      provides: "Map screenshot capture utility"
      exports: ["captureZoneMap"]
  key_links:
    - from: "src/services/overpass.js"
      to: "Overpass API"
      via: "fetch with highway query"
      pattern: 'highway.*name'
    - from: "src/utils/mapCapture.js"
      to: "leaflet-simple-map-screenshoter"
      via: "SimpleMapScreenshoter import"
      pattern: "SimpleMapScreenshoter"
---

<objective>
Set up export infrastructure: install dependencies, extend Overpass service with street queries, and create map capture utility.

Purpose: Foundation for PDF/CSV export - street data fetching and map screenshot capabilities.
Output: Extended overpass.js with getStreetsInBbox(), new mapCapture.js utility.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-zone-export/08-RESEARCH.md

@src/services/overpass.js
@src/map/zoneLayer.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install export dependencies and extend Overpass service</name>
  <files>
    package.json
    src/services/overpass.js
  </files>
  <action>
1. Install jspdf and leaflet-simple-map-screenshoter:
   npm install jspdf leaflet-simple-map-screenshoter

2. Extend src/services/overpass.js with getStreetsInBbox function:
   - Reuse existing getBoundingBox helper
   - Query named highways (residential, primary, secondary, tertiary, unclassified, living_street)
   - Filter streets with "name" tag only (skip unnamed roads)
   - Return unique, French-locale sorted array of street names
   - Use same endpoint fallback pattern as countBuildingsDetailed

Query pattern from research:
```
[out:json][timeout:30];
(
  way["highway"~"^(residential|primary|secondary|tertiary|unclassified|living_street)$"]
     ["name"]
     (${south},${west},${north},${east});
);
out tags;
```

Export both countBuildingsDetailed (existing) and getStreetsInBbox (new).
  </action>
  <verify>
    npm run build succeeds
    grep -q "getStreetsInBbox" src/services/overpass.js
  </verify>
  <done>
    getStreetsInBbox exported from overpass.js, accepts GeoJSON polygon, returns Promise<string[]> of sorted street names
  </done>
</task>

<task type="auto">
  <name>Task 2: Create map capture utility</name>
  <files>
    src/utils/mapCapture.js
  </files>
  <action>
Create src/utils/mapCapture.js with captureZoneMap function:

1. Import SimpleMapScreenshoter from leaflet-simple-map-screenshoter
2. Accept map instance and zone object
3. Store current map view (bounds, zoom)
4. Fit map to zone bounds with padding
5. Wait for tiles to load (1.5 second delay - from research)
6. Capture screenshot as blob using screenshoter.takeScreen('blob')
7. Restore original map view
8. Clean up screenshoter control
9. Return blob

Configuration for screenshoter:
- hidden: true (no UI button)
- preventDownload: true (we handle download ourselves)
- mimeType: 'image/png'

Use L.geoJSON(zone.geojson).getBounds() to get zone bounds.
Export captureZoneMap function.
  </action>
  <verify>
    npm run build succeeds
    grep -q "SimpleMapScreenshoter" src/utils/mapCapture.js
    grep -q "captureZoneMap" src/utils/mapCapture.js
  </verify>
  <done>
    mapCapture.js exports captureZoneMap(map, zone) that returns Promise<Blob> of zone map screenshot
  </done>
</task>

</tasks>

<verification>
1. npm run build - no TypeScript or bundling errors
2. Verify new dependencies in node_modules: jspdf, leaflet-simple-map-screenshoter
3. Check exports in overpass.js include both countBuildingsDetailed and getStreetsInBbox
4. Check mapCapture.js exists and exports captureZoneMap
</verification>

<success_criteria>
- jspdf and leaflet-simple-map-screenshoter installed
- getStreetsInBbox function queries Overpass for named highways in zone bbox
- captureZoneMap function captures zone map as PNG blob
- Both can be imported and used by downstream export service
</success_criteria>

<output>
After completion, create `.planning/phases/08-zone-export/08-01-SUMMARY.md`
</output>
