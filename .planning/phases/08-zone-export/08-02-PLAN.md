---
phase: 08-zone-export
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/services/zoneExport.js
autonomous: true

must_haves:
  truths:
    - "Zone can be exported as PDF with name, members, map image, and streets"
    - "Zone can be exported as CSV with structured data"
  artifacts:
    - path: "src/services/zoneExport.js"
      provides: "PDF and CSV export functions"
      exports: ["exportZonePDF", "exportZoneCSV"]
  key_links:
    - from: "src/services/zoneExport.js"
      to: "src/services/overpass.js"
      via: "getStreetsInBbox import"
      pattern: "import.*getStreetsInBbox.*from.*overpass"
    - from: "src/services/zoneExport.js"
      to: "src/utils/mapCapture.js"
      via: "captureZoneMap import"
      pattern: "import.*captureZoneMap.*from.*mapCapture"
    - from: "src/services/zoneExport.js"
      to: "jspdf"
      via: "jsPDF import"
      pattern: "import.*jsPDF.*from.*jspdf"
---

<objective>
Create zone export service with PDF and CSV generation capabilities.

Purpose: Core export logic - generates downloadable PDF documents with zone details and CSV files with structured data.
Output: zoneExport.js service with exportZonePDF and exportZoneCSV functions.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-zone-export/08-RESEARCH.md
@.planning/phases/08-zone-export/08-01-SUMMARY.md

@src/services/overpass.js
@src/utils/mapCapture.js
@src/state/store.js
@src/ui/exportImport.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF export function</name>
  <files>
    src/services/zoneExport.js
  </files>
  <action>
Create src/services/zoneExport.js with exportZonePDF function:

1. Import dependencies:
   - jsPDF from 'jspdf'
   - store from '../state/store.js'
   - captureZoneMap from '../utils/mapCapture.js'
   - getStreetsInBbox from './overpass.js'

2. exportZonePDF(zone, map, onProgress) function:
   - onProgress callback for UI updates: onProgress(message)

   a. Report progress: "Recuperation des rues..."
   b. Fetch streets via getStreetsInBbox(zone.geojson)

   c. Report progress: "Capture de la carte..."
   d. Capture map via captureZoneMap(map, zone)

   e. Report progress: "Generation du PDF..."
   f. Create jsPDF document (A4, portrait, mm units)

   g. Build PDF content:
      - Title: zone.name (18pt, bold-ish via setFontSize)
      - Subtitle: "Colistiers: " + assigned member names (12pt)
      - Map image: Convert blob to base64, addImage at y=40, width=180mm
      - Street list header: "Rues de la zone" (14pt)
      - Street list: Each street on new line (10pt), paginate if needed

   h. Save PDF: doc.save(`zone-${zone.name}.pdf`)

3. Helper: Get assigned member names from store:
   - store.getTeamMembers().filter(m => zone.assignedMembers?.includes(m.id))
   - Map to member.name, join with ", "

4. Use FileReader to convert blob to base64 data URL for addImage.

PDF layout (A4 = 210x297mm, margin 15mm):
- y=20: Zone name
- y=30: Colistiers
- y=40: Map image (height ~100mm)
- y=150: "Rues de la zone"
- y=160+: Street list (10pt, ~5mm per line)
  </action>
  <verify>
    npm run build succeeds
    grep -q "exportZonePDF" src/services/zoneExport.js
    grep -q "jsPDF" src/services/zoneExport.js
  </verify>
  <done>
    exportZonePDF(zone, map, onProgress) generates and downloads PDF with zone name, members, map image, and street list
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV export function</name>
  <files>
    src/services/zoneExport.js
  </files>
  <action>
Add exportZoneCSV function to src/services/zoneExport.js:

1. exportZoneCSV(zone, streets) function:
   - Takes zone and pre-fetched streets array (from PDF flow or separate call)

   a. Get assigned member names (same helper as PDF)

   b. Build CSV rows with French headers:
      - Row 0: ["Zone", "Rue", "Colistiers"]
      - Row 1: [zone.name, streets[0] || "", memberNames]
      - Rows 2+: ["", street, ""] for remaining streets

   c. Escape CSV properly:
      - Wrap each cell in double quotes
      - Escape internal quotes by doubling: " -> ""

   d. Add UTF-8 BOM for Excel compatibility: '\ufeff'

   e. Create Blob with type 'text/csv;charset=utf-8'

   f. Download using same pattern as exportImport.js:
      - URL.createObjectURL
      - Create anchor, set href and download
      - Click, remove, revoke URL

   g. Filename: zone-${zone.name}.csv

Export both exportZonePDF and exportZoneCSV.
  </action>
  <verify>
    npm run build succeeds
    grep -q "exportZoneCSV" src/services/zoneExport.js
    grep -q "text/csv" src/services/zoneExport.js
  </verify>
  <done>
    exportZoneCSV(zone, streets) generates and downloads CSV with zone name, streets, and assigned members
  </done>
</task>

</tasks>

<verification>
1. npm run build - no errors
2. zoneExport.js exports both exportZonePDF and exportZoneCSV
3. PDF function uses jsPDF, captureZoneMap, getStreetsInBbox
4. CSV function uses BOM for French character support
</verification>

<success_criteria>
- exportZonePDF generates A4 PDF with zone name, colistiers, map image, street list
- exportZoneCSV generates CSV with zone, streets, members columns
- Both trigger browser download with appropriate filenames
- Progress callback allows UI to show loading states
</success_criteria>

<output>
After completion, create `.planning/phases/08-zone-export/08-02-SUMMARY.md`
</output>
