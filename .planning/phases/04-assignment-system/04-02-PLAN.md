---
phase: 04-assignment-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/map/zoneLayer.js
  - src/ui/zoneEditor.js
autonomous: true

must_haves:
  truths:
    - "Zone polygon color changes to match assigned team member's color"
    - "Unassigned zones display in red (original style)"
    - "Color updates immediately after assignment is saved"
    - "Color persists correctly after page refresh"
  artifacts:
    - path: "src/map/zoneLayer.js"
      provides: "Dynamic zone styling based on assignment"
      contains: "updateZoneStyle"
  key_links:
    - from: "src/map/zoneLayer.js"
      to: "src/map/markerStyles.js"
      via: "getTeamMemberColor import"
      pattern: "getTeamMemberColor"
    - from: "src/ui/zoneEditor.js"
      to: "src/map/zoneLayer.js"
      via: "style update after save"
      pattern: "updateZoneStyle"
---

<objective>
Implement dynamic zone polygon styling that reflects team member assignment through color changes.

Purpose: Provide immediate visual feedback when team members are assigned to zones, making the distribution map intuitive at a glance.
Output: Zone polygons colored by first assigned team member's color, or red when unassigned.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-assignment-system/04-RESEARCH.md
@.planning/phases/04-assignment-system/04-01-SUMMARY.md

# Files to modify
@src/map/zoneLayer.js
@src/map/markerStyles.js
@src/ui/zoneEditor.js
@src/state/store.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updateZoneStyle function to zoneLayer.js</name>
  <files>src/map/zoneLayer.js</files>
  <action>
1. Import getTeamMemberColor from '../map/markerStyles.js' at top of file

2. Create and export updateZoneStyle function:
   ```javascript
   export function updateZoneStyle(zoneId) {
     const layer = layersByZoneId.get(zoneId);
     if (!layer) return;

     const zone = store.getZones().find(z => z.id === zoneId);
     if (!zone) return;

     if (zone.assignedMembers && zone.assignedMembers.length > 0) {
       // Use first assigned member's color
       const members = store.getTeamMembers();
       const memberIndex = members.findIndex(m => m.id === zone.assignedMembers[0]);

       if (memberIndex !== -1) {
         const color = getTeamMemberColor(memberIndex);
         layer.setStyle({
           color: color,
           fillColor: color,
           fillOpacity: 0.3,
           weight: 2
         });
       }
     } else {
       // Unassigned - red (original style)
       layer.setStyle(ZONE_STYLE);
     }
   }
   ```

3. In loadZonesFromStore(), after creating each layer, call updateZoneStyle(zone.id) to apply correct initial color based on stored assignment data

4. Subscribe to 'zoneUpdated' event to auto-update styling:
   ```javascript
   subscribe('zoneUpdated', (zone) => {
     updateZoneStyle(zone.id);
   });
   ```
   Add this subscription in initZoneLayer() after other subscriptions
  </action>
  <verify>
    - grep "export function updateZoneStyle" src/map/zoneLayer.js
    - grep "getTeamMemberColor" src/map/zoneLayer.js
    - grep "subscribe.*zoneUpdated" src/map/zoneLayer.js
    - grep "layer.setStyle" src/map/zoneLayer.js | wc -l (should be 2+)
  </verify>
  <done>
    - updateZoneStyle function exists and is exported
    - Function uses first assigned member's color from palette
    - Zones loaded from store display correct colors on page load
    - zoneUpdated events trigger automatic style refresh
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire style update to zone editor save</name>
  <files>src/ui/zoneEditor.js</files>
  <action>
1. Import updateZoneStyle from '../map/zoneLayer.js'

2. In form submit handler, after store.updateZone() call, explicitly call updateZoneStyle(zoneId):
   ```javascript
   // Update store
   store.updateZone(zoneId, updates);

   // Update visual style immediately
   updateZoneStyle(zoneId);
   ```

Note: This provides immediate feedback even though the zoneUpdated subscription also triggers it. The explicit call ensures no race condition or delay.
  </action>
  <verify>
    - grep "import.*updateZoneStyle" src/ui/zoneEditor.js
    - grep "updateZoneStyle" src/ui/zoneEditor.js | grep -v import
  </verify>
  <done>
    - Zone editor imports updateZoneStyle
    - Saving assignment immediately updates polygon color
    - No delay between save and visual update
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify color mapping end-to-end</name>
  <files>test-zone-styling.html</files>
  <action>
1. Create test-zone-styling.html in project root with verification steps:
   - Prerequisites: Have team members imported (CSV import from Phase 2)
   - Test cases:
     a. Draw new zone -> verify red color (unassigned)
     b. Assign first team member -> verify zone becomes member's color (magenta for first)
     c. Remove assignment -> verify zone returns to red
     d. Assign second team member -> verify zone becomes blue (second color in palette)
     e. Assign multiple members -> verify color matches FIRST assigned (order matters)
     f. Refresh page -> verify colors persist correctly

2. Include color reference from markerStyles.js:
   - Index 0: #c30b82 (magenta)
   - Index 1: #2563eb (blue)
   - Index 2: #16a34a (green)
   - etc.

3. Console verification:
   ```javascript
   // Check zone has assignment
   const zones = JSON.parse(localStorage.getItem('vivons_chapet_data')).zones;
   zones.find(z => z.assignedMembers?.length > 0);
   ```
  </action>
  <verify>
    - test-zone-styling.html exists
    - npm run dev and follow manual test cases
    - Zone colors match assigned team member colors visually
  </verify>
  <done>
    - Unassigned zones display red
    - Assigned zones display first member's color
    - Color updates immediately on save
    - Colors persist across page refresh
    - Visual mapping matches team list colors in side panel
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Code verification:
   - updateZoneStyle function exported from zoneLayer.js
   - getTeamMemberColor imported from markerStyles.js
   - zoneUpdated subscription exists
   - zoneEditor.js calls updateZoneStyle after save

2. Visual verification (manual):
   - New zone = red
   - Assigned zone = team member color
   - Unassigned zone = back to red
   - Page refresh = colors maintained
</verification>

<success_criteria>
- Zone polygon border and fill color match first assigned team member's marker color
- Unassigned zones remain red (#ef4444 border, #fca5a5 fill)
- Color changes instantly when assignment is saved (no page refresh needed)
- Colors restore correctly from localStorage on page load
- Multiple-assignment zones use first member's color
</success_criteria>

<output>
After completion, create `.planning/phases/04-assignment-system/04-02-SUMMARY.md`
</output>
