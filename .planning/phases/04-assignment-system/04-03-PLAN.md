---
phase: 04-assignment-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - index.html
  - src/ui/exportImport.js
  - src/main.js
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "User can export all data to JSON file"
    - "User can import previously saved JSON to restore state"
    - "Import confirms before overwriting existing data"
    - "Invalid JSON files show error message"
    - "Imported data displays correctly on map"
  artifacts:
    - path: "src/ui/exportImport.js"
      provides: "Export and import functionality"
      exports: ["initExportImport", "exportToJSON"]
    - path: "index.html"
      provides: "Export/Import UI buttons"
      contains: "export-btn"
  key_links:
    - from: "src/ui/exportImport.js"
      to: "src/state/store.js"
      via: "reads/writes state"
      pattern: "store\\.(getTeamMembers|getZones|state)"
    - from: "src/ui/exportImport.js"
      to: "Blob API"
      via: "file download"
      pattern: "URL\\.createObjectURL"
---

<objective>
Implement JSON export and import for complete data persistence with file validation and confirmation.

Purpose: Allow users to backup their work to a file and restore it later, enabling data portability and recovery.
Output: Export button downloads JSON file with all data, import input restores state from uploaded file.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-assignment-system/04-RESEARCH.md

# Files to extend
@index.html
@src/main.js
@src/state/store.js
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export/import UI to side panel</name>
  <files>index.html, src/style.css</files>
  <action>
1. In index.html, add export/import section to side-panel (after team-list div):
   ```html
   <div class="panel-footer">
     <button id="export-btn" class="action-btn">Exporter JSON</button>
     <label class="action-btn import-label">
       Importer JSON
       <input type="file" id="import-file" accept=".json" hidden>
     </label>
   </div>
   ```

2. In src/style.css, add footer styles:
   - .panel-footer: flexbox row, gap 8px, padding, border-top separator
   - .action-btn: consistent button styling (same as import-btn pattern)
   - .import-label: cursor pointer, display as button
   - Responsive: stack vertically on narrow panels if needed
  </action>
  <verify>
    - grep "export-btn" index.html
    - grep "import-file" index.html
    - grep "panel-footer" src/style.css
  </verify>
  <done>
    - Export button visible in side panel
    - Import button (styled as file input label) visible in side panel
    - Buttons have consistent styling with existing UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create exportImport.js with export function</name>
  <files>src/ui/exportImport.js</files>
  <action>
1. Create src/ui/exportImport.js with:
   - Import store from '../state/store.js'

2. Implement exportToJSON function:
   ```javascript
   export function exportToJSON() {
     const data = {
       version: '1.0',
       exportedAt: new Date().toISOString(),
       teamMembers: store.getTeamMembers(),
       zones: store.getZones()
     };

     const json = JSON.stringify(data, null, 2);
     const blob = new Blob([json], { type: 'application/json' });
     const url = URL.createObjectURL(blob);

     const a = document.createElement('a');
     a.href = url;
     a.download = `vivons-chapet-${Date.now()}.json`;
     document.body.appendChild(a);
     a.click();
     document.body.removeChild(a);

     // Clean up blob URL to prevent memory leak
     URL.revokeObjectURL(url);
   }
   ```

3. Implement initExportImport function:
   - Attach click handler to #export-btn that calls exportToJSON()
   - Export initExportImport for use in main.js
  </action>
  <verify>
    - grep "export function exportToJSON" src/ui/exportImport.js
    - grep "URL.createObjectURL" src/ui/exportImport.js
    - grep "URL.revokeObjectURL" src/ui/exportImport.js
    - grep "initExportImport" src/ui/exportImport.js
  </verify>
  <done>
    - exportToJSON creates downloadable JSON file
    - File includes version, timestamp, teamMembers, zones
    - Blob URL is cleaned up after download
    - Export button is wired to function
  </done>
</task>

<task type="auto">
  <name>Task 3: Add import with validation and confirmation</name>
  <files>src/ui/exportImport.js, src/main.js</files>
  <action>
1. In src/ui/exportImport.js, add import handling to initExportImport:
   ```javascript
   const fileInput = document.getElementById('import-file');

   fileInput.addEventListener('change', () => {
     const [file] = fileInput.files;
     if (!file) return;

     // Validate file type
     if (!file.name.endsWith('.json')) {
       alert('Veuillez sélectionner un fichier JSON');
       fileInput.value = '';
       return;
     }

     // Validate file size (max 5MB)
     if (file.size > 5 * 1024 * 1024) {
       alert('Fichier trop volumineux (max 5 Mo)');
       fileInput.value = '';
       return;
     }

     const reader = new FileReader();

     reader.onload = (event) => {
       try {
         const data = JSON.parse(event.target.result);

         if (!validateImportData(data)) {
           throw new Error('Structure de données invalide');
         }

         // Confirm before overwrite
         if (!confirm('L\'import remplacera toutes les données actuelles. Continuer ?')) {
           fileInput.value = '';
           return;
         }

         importData(data);
         alert('Données importées avec succès');

       } catch (error) {
         alert('Fichier JSON invalide: ' + error.message);
       }
       fileInput.value = '';
     };

     reader.onerror = () => {
       alert('Erreur lors de la lecture du fichier');
       fileInput.value = '';
     };

     reader.readAsText(file);
   });
   ```

2. Add validateImportData function:
   ```javascript
   function validateImportData(data) {
     if (!data.teamMembers || !data.zones) return false;
     if (!Array.isArray(data.teamMembers) || !Array.isArray(data.zones)) return false;

     // Validate team member structure
     for (const member of data.teamMembers) {
       if (!member.id || !member.name) return false;
     }

     // Validate zone structure
     for (const zone of data.zones) {
       if (!zone.id || !zone.name || !zone.geojson) return false;
     }

     return true;
   }
   ```

3. Add importData function that uses store's internal state and events:
   ```javascript
   function importData(data) {
     // Update store state directly (store.state is accessible)
     store.state.teamMembers = data.teamMembers;
     store.state.zones = data.zones;

     // Trigger reload events for all subscribers
     store.pubsub.publish('teamMembersLoaded', data.teamMembers);
     store.pubsub.publish('zonesLoaded', data.zones);

     // Save to localStorage
     store._debouncedSave();
   }
   ```
   Note: This requires updating store.js to expose state and pubsub, OR using existing public methods. Check store.js exports and adjust accordingly.

4. In src/main.js:
   - Import initExportImport from './ui/exportImport.js'
   - Call initExportImport() during app initialization
  </action>
  <verify>
    - grep "validateImportData" src/ui/exportImport.js
    - grep "FileReader" src/ui/exportImport.js
    - grep "confirm.*import" src/ui/exportImport.js
    - grep "initExportImport" src/main.js
    - npm run dev (no build errors)
  </verify>
  <done>
    - Import validates file type (.json) and size (max 5MB)
    - Import validates data structure (required fields)
    - Import shows confirmation before overwriting
    - Invalid files show clear error messages
    - Successful import triggers map and panel refresh
    - File input resets after each import attempt
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Code verification:
   - Export button exists and triggers download
   - Import input exists and processes files
   - Validation checks file type, size, and structure
   - Confirmation dialog appears before import
   - Events trigger UI refresh after import

2. Functional verification (manual):
   - Create some data (team + zones with assignments)
   - Export -> JSON file downloads
   - Clear localStorage manually or open incognito
   - Import the file -> confirm -> data restored
   - Map shows zones with correct colors
   - Side panel shows team members
</verification>

<success_criteria>
- Export downloads JSON file with version, timestamp, teamMembers, zones
- Import validates file type (.json only)
- Import validates file size (max 5MB)
- Import validates data structure (required fields present)
- Import requires user confirmation before overwriting
- After import: map displays zones, side panel displays team members
- After import: zone colors reflect assignments (via zonesLoaded event)
- Filename includes timestamp for uniqueness (vivons-chapet-{timestamp}.json)
</success_criteria>

<output>
After completion, create `.planning/phases/04-assignment-system/04-03-SUMMARY.md`
</output>
