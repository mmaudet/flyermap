---
phase: 04-assignment-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - src/ui/zoneEditor.js
  - src/map/zoneLayer.js
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "User can click a zone to open an editing panel"
    - "User can assign one or more team members to a zone"
    - "User can edit zone name in the panel"
    - "User can record estimated mailbox count"
    - "User can add notes to a zone"
    - "Assignment data persists across page refresh"
  artifacts:
    - path: "src/ui/zoneEditor.js"
      provides: "Zone editor dialog component"
      exports: ["initZoneEditor", "openZoneEditor"]
    - path: "index.html"
      provides: "Dialog HTML structure"
      contains: "<dialog id=\"zone-editor\">"
  key_links:
    - from: "src/map/zoneLayer.js"
      to: "src/ui/zoneEditor.js"
      via: "zone click opens editor"
      pattern: "openZoneEditor"
    - from: "src/ui/zoneEditor.js"
      to: "src/state/store.js"
      via: "form submit updates zone"
      pattern: "store\\.updateZone"
---

<objective>
Create zone editor dialog for assigning team members to zones with name, mailbox count, and notes editing.

Purpose: Enable users to assign team members to distribution zones and record zone metadata (mailbox count, notes) through a modal interface triggered by clicking on a zone polygon.
Output: Zone editor dialog component, zone click handler wiring, and multi-select assignment UI.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-assignment-system/04-RESEARCH.md

# Existing files to extend
@src/map/zoneLayer.js
@src/state/store.js
@src/ui/sidePanel.js
@index.html
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create zone editor dialog component</name>
  <files>index.html, src/ui/zoneEditor.js, src/style.css</files>
  <action>
1. Add dialog HTML to index.html (before closing body tag):
   - Native `<dialog id="zone-editor">` element
   - Form with `method="dialog"` for automatic close handling
   - Fields: zone name (text input), assigned members (select multiple), mailbox count (number input), notes (textarea)
   - Buttons: Save (value="save"), Cancel (value="cancel")
   - Use semantic HTML with labels

2. Create src/ui/zoneEditor.js:
   - Import store and subscribe from '../state/store.js'
   - initZoneEditor() function:
     - Gets dialog element reference
     - Attaches form submit handler
     - On submit with returnValue="save": collects form data, calls store.updateZone()
     - Clears form after submit
   - openZoneEditor(zone) function:
     - Populates form fields from zone object
     - Populates team member select from store.getTeamMembers()
     - Marks currently assigned members as selected (zone.assignedMembers array)
     - Stores zone.id in dialog.dataset.zoneId
     - Calls dialog.showModal()
   - Export both functions

3. Add dialog styles to src/style.css:
   - dialog::backdrop with semi-transparent overlay
   - dialog styling: white background, rounded corners, shadow, max-width 400px
   - Form field styling: full-width inputs, consistent padding
   - select[multiple] styling: min-height for visibility (150px)
   - Button row with flexbox, gap between buttons
  </action>
  <verify>
    - grep "dialog id=\"zone-editor\"" index.html
    - grep "method=\"dialog\"" index.html
    - grep "select.*multiple.*assigned-members" index.html
    - grep "initZoneEditor" src/ui/zoneEditor.js
    - grep "openZoneEditor" src/ui/zoneEditor.js
    - grep "store.updateZone" src/ui/zoneEditor.js
    - npm run dev (check no build errors)
  </verify>
  <done>
    - Dialog HTML exists in index.html with all form fields
    - zoneEditor.js exports initZoneEditor and openZoneEditor
    - Form submit handler calls store.updateZone with assignment data
    - Dialog styles provide clean modal appearance
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire zone click to open editor dialog</name>
  <files>src/map/zoneLayer.js, src/main.js</files>
  <action>
1. In src/map/zoneLayer.js:
   - Import openZoneEditor from '../ui/zoneEditor.js'
   - In loadZonesFromStore(), add click handler to each restored layer:
     ```javascript
     layer.on('click', (e) => {
       L.DomEvent.stopPropagation(e);
       const zone = store.getZones().find(z => z.id === zoneId);
       if (zone) openZoneEditor(zone);
     });
     ```
   - In pm:create handler, add same click handler to newly created zones

2. In src/main.js:
   - Import initZoneEditor from './ui/zoneEditor.js'
   - Call initZoneEditor() during app initialization (after initZoneLayer)

Note: Use L.DomEvent.stopPropagation to prevent click from triggering map events or interfering with Geoman edit mode.
  </action>
  <verify>
    - grep "openZoneEditor" src/map/zoneLayer.js
    - grep "layer.on('click'" src/map/zoneLayer.js
    - grep "initZoneEditor" src/main.js
    - npm run dev (manual test: draw zone, click it, verify dialog opens)
  </verify>
  <done>
    - Clicking a zone polygon opens the editor dialog
    - Dialog shows zone's current name and any existing data
    - Team member select is populated with all team members
    - Saving updates the zone in store (verifiable in localStorage)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify assignment persistence and form cycle</name>
  <files>test-zone-editor.html</files>
  <action>
1. Create test-zone-editor.html in project root:
   - Simple HTML test harness
   - Instructions for manual verification:
     a. Import CSV with team members (use existing sample)
     b. Draw a zone on the map
     c. Click the zone to open editor
     d. Assign 2+ team members using multi-select (Ctrl/Cmd+click)
     e. Enter mailbox count (e.g., 150)
     f. Add notes (e.g., "Quartier pavillonnaire")
     g. Save and verify popup still shows zone name
     h. Click zone again - verify all fields retained
     i. Refresh page - click zone - verify data persisted
   - Console verification steps:
     ```javascript
     // Check localStorage
     JSON.parse(localStorage.getItem('vivons_chapet_data')).zones
     // Should show assignedMembers array, mailboxCount, notes
     ```

2. Manual verification checklist embedded in file
  </action>
  <verify>
    - test-zone-editor.html exists with verification steps
    - npm run dev and follow test steps manually
  </verify>
  <done>
    - Zone editor saves all fields to store
    - Multi-select assignment works (multiple members selectable)
    - All data persists across page refresh
    - Re-opening editor shows previously saved values
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Code verification:
   - dialog element exists in index.html
   - zoneEditor.js exports initZoneEditor and openZoneEditor
   - zoneLayer.js imports and uses openZoneEditor
   - main.js initializes zone editor
   - store.updateZone receives assignedMembers, mailboxCount, notes

2. Functional verification (manual):
   - Click zone -> dialog opens
   - Multi-select team members -> works
   - Save -> dialog closes, data in localStorage
   - Refresh -> click zone -> previous data displayed
</verification>

<success_criteria>
- User can click any zone to open editor dialog
- User can assign multiple team members via multi-select
- User can edit zone name, mailbox count, and notes
- All zone data persists across browser sessions
- Cancel button closes dialog without saving
- Save button updates store and closes dialog
</success_criteria>

<output>
After completion, create `.planning/phases/04-assignment-system/04-01-SUMMARY.md`
</output>
