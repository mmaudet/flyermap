---
phase: 07-reconfiguration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/ui/reconfigure.js
  - src/main.js
autonomous: true

must_haves:
  truths:
    - "User can click reconfigure button and see confirmation dialog"
    - "Dialog shows current count of team members and zones"
    - "Clicking Cancel closes dialog without data loss"
    - "Clicking Confirm clears data and reloads page to show wizard"
  artifacts:
    - path: "src/ui/reconfigure.js"
      provides: "Reconfigure button handler and data clearing logic"
      exports: ["initReconfigure"]
    - path: "src/main.js"
      provides: "Reconfigure initialization on app startup"
      contains: "initReconfigure"
  key_links:
    - from: "src/ui/reconfigure.js"
      to: "src/state/store.js"
      via: "store.getTeamMembers() and store.getZones()"
      pattern: "store\\.get(TeamMembers|Zones)"
    - from: "src/ui/reconfigure.js"
      to: "src/data/storage.js"
      via: "storage.remove() for data clearing"
      pattern: "storage\\.remove"
    - from: "src/ui/reconfigure.js"
      to: "index.html"
      via: "dialog.showModal() and button click"
      pattern: "getElementById.*reconfigure"
---

<objective>
Wire reconfigure button to confirmation dialog with data clearing logic

Purpose: Enable users to reset configuration by clearing localStorage and restarting wizard
Output: Functional reconfigure flow with data count display and proper clearing
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-reconfiguration/07-RESEARCH.md
@.planning/phases/07-reconfiguration/07-01-SUMMARY.md
@src/data/storage.js
@src/state/store.js
@src/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reconfigure module with button and dialog logic</name>
  <files>src/ui/reconfigure.js</files>
  <action>
Create new module `src/ui/reconfigure.js` that handles the reconfiguration flow.

Import dependencies:
- `storage` from '../data/storage.js' (default export)
- `store` from '../state/store.js'

Export function `initReconfigure()` that:
1. Gets DOM elements:
   - `const btn = document.getElementById('reconfigure-btn')`
   - `const dialog = document.getElementById('reconfigure-confirm')`
2. Early return if elements not found (with console.error)
3. Adds click handler to btn that:
   - Calls `updateDataCounts()` to show current numbers
   - Calls `dialog.showModal()`
4. Adds 'close' event listener to dialog that:
   - Checks `dialog.returnValue === 'confirm'`
   - If confirm: calls `clearAllUserData()` then `window.location.reload()`
   - If cancel/ESC: do nothing (data preserved)

Helper function `updateDataCounts()`:
- Gets members count via `store.getTeamMembers().length`
- Gets zones count via `store.getZones().length`
- Updates `document.getElementById('member-count').textContent`
- Updates `document.getElementById('zone-count').textContent`

Helper function `clearAllUserData()`:
- Calls `storage.remove('flyermap_commune')` - commune config
- Calls `storage.remove('flyermap_data')` - team members + zones
- Log to console: 'FlyerMap data cleared'

Use the exact localStorage keys from the research (flyermap_commune and flyermap_data).
  </action>
  <verify>
File exists at src/ui/reconfigure.js with:
- initReconfigure export
- updateDataCounts function
- clearAllUserData function
- Proper imports from storage and store
  </verify>
  <done>
reconfigure.js exports initReconfigure() that wires button click to dialog, updates counts, and handles confirm/cancel with data clearing
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize reconfigure module in main.js</name>
  <files>src/main.js</files>
  <action>
Update src/main.js to import and initialize the reconfigure module.

Add import at top with other UI imports:
```javascript
import { initReconfigure } from './ui/reconfigure.js';
```

Call `initReconfigure()` in the appropriate place:
- Should be called regardless of first-launch detection
- Add after `initSidePanel()` or similar UI initialization
- The reconfigure button should be available whether wizard runs or not

The existing main.js likely has a pattern like:
```javascript
if (isFirstLaunch()) {
  initWelcomeWizard();
} else {
  initMap();
}
```

Add `initReconfigure()` OUTSIDE the conditional (always initialize).
  </action>
  <verify>
Read main.js and verify:
1. Import statement for initReconfigure exists
2. initReconfigure() is called during initialization
3. Call is not inside first-launch conditional
  </verify>
  <done>
main.js imports and calls initReconfigure() during app startup
  </done>
</task>

<task type="auto">
  <name>Task 3: Test reconfigure flow end-to-end</name>
  <files>src/ui/reconfigure.js, src/main.js</files>
  <action>
Verify the complete reconfigure flow works:

1. Start dev server: `npm run dev`
2. Load app (should show existing data or wizard if first launch)
3. If wizard shows, complete it to get data in localStorage
4. Verify reconfigure button is visible in panel footer
5. Click reconfigure button
6. Verify dialog shows with correct member/zone counts
7. Test Cancel - click Cancel button, verify dialog closes, data still in localStorage
8. Test Confirm - click "Reinitialiser et changer", verify:
   - Page reloads
   - Wizard appears (first-launch detection triggered)
   - localStorage keys removed (check via devtools)

If any issues found, fix them in reconfigure.js.
  </action>
  <verify>
Manual verification steps above pass. Specifically:
- `localStorage.getItem('flyermap_commune')` returns null after confirm
- `localStorage.getItem('flyermap_data')` returns null after confirm
- Wizard appears after page reload
  </verify>
  <done>
Reconfigure flow works: button shows dialog, Cancel preserves data, Confirm clears data and restarts wizard
  </done>
</task>

</tasks>

<verification>
1. npm run dev starts without errors
2. Reconfigure button visible in panel footer
3. Clicking button opens confirmation dialog
4. Dialog shows accurate member/zone counts
5. Cancel button closes dialog without clearing data
6. ESC key closes dialog without clearing data
7. Confirm button clears both localStorage keys
8. Page reloads to show wizard after confirm
9. No console errors during flow
</verification>

<success_criteria>
- RECONF-01: Reconfigure button accessible from main interface
- RECONF-02: Warning dialog shows before data deletion
- RECONF-03: Cancel option preserves all data
- Full round-trip: configure -> use app -> reconfigure -> configure again
</success_criteria>

<output>
After completion, create `.planning/phases/07-reconfiguration/07-02-SUMMARY.md`
</output>
