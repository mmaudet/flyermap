---
phase: 06-csv-import-wizard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/ui/wizard.js
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "User can upload CSV via drag-and-drop"
    - "User can upload CSV via file browser button"
    - "User sees validation errors with line numbers"
    - "User sees preview of valid data before geocoding"
  artifacts:
    - path: "src/ui/wizard.js"
      provides: "File upload and validation logic"
      contains: "setupUploadStep"
    - path: "src/style.css"
      provides: "Drop zone and validation styles"
      contains: "drop-zone"
  key_links:
    - from: "src/ui/wizard.js"
      to: "src/services/csvImport.js"
      via: "import parseCSV, validateTeamMembers"
      pattern: "import.*parseCSV.*csvImport"
    - from: "src/ui/wizard.js"
      to: "#csv-drop-zone"
      via: "getElementById"
      pattern: 'getElementById.*csv-drop-zone'
---

<objective>
Implement file upload step with drag-and-drop and validation step with error display.

Purpose: Enable users to upload CSV files via drag-and-drop or file browser, then validate the CSV and show results with per-row error messages or data preview.

Output: Updated wizard.js with upload/validation handlers, updated style.css with drop zone and validation styles.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-csv-import-wizard/06-RESEARCH.md

@src/ui/wizard.js
@src/services/csvImport.js
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement file upload step with drag-and-drop</name>
  <files>src/ui/wizard.js</files>
  <action>
Add import at top of file:
```javascript
import { parseCSV, validateTeamMembers, normalizeTeamMember } from '../services/csvImport.js';
```

Add module-scoped variables after existing ones:
```javascript
// CSV import state
let selectedFile = null;
let validatedMembers = null;
```

Create setupUploadStep() function:
1. Get elements: csv-drop-zone, wizard-csv-input, csv-file-info
2. Prevent default drag behaviors on the drop zone:
   - Add listeners for dragenter, dragover, dragleave, drop
   - Call e.preventDefault() and e.stopPropagation() on all
3. Add visual feedback:
   - On dragenter/dragover: add 'drag-over' class to drop zone
   - On dragleave/drop: remove 'drag-over' class
4. Handle drop event:
   - Get files from e.dataTransfer.files
   - Filter for .csv extension
   - If no CSV found, show error in file-info div
   - If CSV found, call handleFileSelected(file)
5. Handle file input change event:
   - Get file from e.target.files[0]
   - If file exists, call handleFileSelected(file)

Create handleFileSelected(file) function:
1. Validate file extension is .csv
2. Warn if file > 1MB (show confirm dialog)
3. Store file in selectedFile module variable
4. Show file info in csv-file-info div:
   - Make div visible (hidden = false)
   - Display filename and size in KB
5. Clear any previous validation state (validatedMembers = null)

Call setupUploadStep() in initWelcomeWizard() after setupPreviewStep().

DO NOT wire up next button enabling yet - that's handled by the validation step transition.
  </action>
  <verify>
Run dev server. Navigate to Import step (step 5). Drag a CSV file over drop zone - should show visual feedback. Drop file - should display filename. Click "Parcourir" button - should open file picker.
  </verify>
  <done>
Drop zone accepts drag-and-drop files, file input works as fallback, selected file info displays correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement validation step with error display</name>
  <files>src/ui/wizard.js</files>
  <action>
Create runValidationStep() async function:
1. Get validation-results container element
2. If no selectedFile, show error message and return false
3. Show "Analyse en cours..." loading state
4. Try/catch block:
   a. Call parseCSV(selectedFile) - uses existing csvImport.js
   b. If results empty, show "Le fichier est vide ou mal formate" error
   c. Call validateTeamMembers(results) - uses existing csvImport.js
   d. If errors.length > 0:
      - Build error HTML with error count
      - List each error: "Ligne {row}: {message}"
      - Add instruction to fix and re-import
      - Return false
   e. If valid:
      - Normalize members using normalizeTeamMember()
      - Store in validatedMembers module variable
      - Build preview HTML:
        - Success message with count
        - Table with headers: Nom, Adresse, Telephone
        - Show first 10 rows
        - If more than 10, show "... et X autres" row
      - Return true
5. On catch: Show parse error message

Setup validation step trigger:
In setupPreviewStep(), add another event listener for wz.btn.next:
- When wizard.current_step === 4 (after Import step, going to Validation)
- Call runValidationStep() in setTimeout

Create escapeHtml(str) helper function to prevent XSS in preview table:
- Replace &, <, >, " with HTML entities
- Return empty string if str is null/undefined
  </action>
  <verify>
Run dev server. Upload valid CSV template file. Navigate to Validation step. Should see "X colistier(s) valide(s)" with preview table. Upload CSV with missing columns - should see error messages with line numbers.
  </verify>
  <done>
Validation step parses CSV, shows errors with line numbers for invalid files, shows data preview for valid files.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add drop zone and validation CSS styles</name>
  <files>src/style.css</files>
  <action>
Add CSS at end of file for wizard CSV import UI:

/* Wizard CSV Import Styles */

.drop-zone {
  border: 2px dashed #d1d5db;
  border-radius: 8px;
  padding: 40px 20px;
  text-align: center;
  background: #f9fafb;
  transition: all 0.2s ease;
  cursor: pointer;
}

.drop-zone.drag-over {
  border-color: #2563eb;
  background: #eff6ff;
}

.drop-zone p {
  margin: 8px 0;
  color: #6b7280;
}

/* Validation results */
.error-box {
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 4px;
  padding: 12px;
  margin: 12px 0;
}

.error-box ul {
  margin: 8px 0 0 0;
  padding-left: 20px;
}

.error-box li {
  color: #dc2626;
  font-size: 14px;
}

.success {
  color: #059669;
}

.error {
  color: #dc2626;
}

.warning {
  color: #d97706;
}

/* Preview table */
.preview-scroll {
  max-height: 200px;
  overflow-y: auto;
  margin: 12px 0;
}

.preview-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.preview-table th,
.preview-table td {
  padding: 6px 8px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

.preview-table th {
  background: #f3f4f6;
  font-weight: 600;
}

.preview-table .more {
  text-align: center;
  color: #6b7280;
  font-style: italic;
}

/* File info display */
#csv-file-info {
  margin-top: 16px;
  padding: 12px;
  background: #f0fdf4;
  border-radius: 4px;
  border: 1px solid #bbf7d0;
}
  </action>
  <verify>
Run dev server. Navigate to Import step. Verify drop zone has dashed border and light gray background. Drag file over - border should turn blue and background light blue. Verify validation results styling (error box red, success green).
  </verify>
  <done>
Drop zone has visual feedback styles, validation results have error/success styling, preview table is scrollable and styled.
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Clear localStorage and refresh to trigger wizard
3. Navigate to Import step (step 5):
   - Drag CSV over drop zone - visual feedback appears
   - Drop valid CSV - filename and size shown
   - Click Parcourir button - file picker opens
4. Navigate to Validation step (step 6):
   - With valid CSV: see success message and preview table
   - With invalid CSV (create one missing 'nom' column): see error with line number
5. Go back to Import, upload different file, forward to Validation - results update
</verification>

<success_criteria>
- Drag-and-drop uploads CSV file with visual feedback
- File input button works as fallback
- Valid CSV shows preview table with first 10 rows
- Invalid CSV shows error list with line numbers
- Styles match existing wizard aesthetic
</success_criteria>

<output>
After completion, create `.planning/phases/06-csv-import-wizard/06-02-SUMMARY.md`
</output>
