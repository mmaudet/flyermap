---
phase: 06-csv-import-wizard
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/ui/wizard.js
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "User sees geocoding progress with count and progress bar"
    - "User sees per-address status during geocoding"
    - "User sees summary of successful and failed geocodes"
    - "Wizard completion saves team members and closes dialog"
    - "Map displays with geocoded team members after wizard"
  artifacts:
    - path: "src/ui/wizard.js"
      provides: "Geocoding step and completion logic"
      contains: "runGeocodingStep"
  key_links:
    - from: "src/ui/wizard.js"
      to: "src/services/geocoding.js"
      via: "import geocodeAddress"
      pattern: "import.*geocodeAddress.*geocoding"
    - from: "src/ui/wizard.js"
      to: "src/state/store.js"
      via: "import store"
      pattern: "import.*store.*store"
    - from: "src/ui/wizard.js"
      to: "#geocoding-progress"
      via: "getElementById"
      pattern: 'getElementById.*geocoding-progress'
---

<objective>
Implement geocoding step with progress display and complete the wizard integration.

Purpose: Geocode validated team member addresses with visual progress feedback, save successful geocodes to store, handle partial failures gracefully, and complete the wizard flow to display the map.

Output: Updated wizard.js with geocoding step handler and completion logic, updated style.css with progress styles.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-csv-import-wizard/06-RESEARCH.md

@src/ui/wizard.js
@src/services/geocoding.js
@src/state/store.js
@src/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement geocoding step with progress display</name>
  <files>src/ui/wizard.js</files>
  <action>
Add import at top of file (if not already present):
```javascript
import { geocodeAddress } from '../services/geocoding.js';
import { store } from '../state/store.js';
```

Create runGeocodingStep() async function:
1. Get elements: geocoding-progress, import-summary
2. If no validatedMembers or empty array, show error and return false
3. Initialize progress UI in geocoding-progress div:
   ```html
   <p>Geocodage des adresses: <span id="geo-current">0</span>/${count}</p>
   <progress id="geo-bar" max="${count}" value="0"></progress>
   <p id="geo-status" class="status"></p>
   ```
4. Track results: successCount, failedCount, failedNames array
5. Loop through validatedMembers sequentially:
   a. Update status: "Traitement: {member.name}..."
   b. Try geocodeAddress(member.address):
      - On success: call store.addTeamMember() with {name, address, phone, lat, lng, geocodeScore}
      - Increment successCount
   c. On catch:
      - Increment failedCount
      - Add name to failedNames array
      - Log warning to console
   d. Update progress bar and current count
   e. Wait 20ms between requests (rate limiting) - except after last one
6. After loop completes:
   - Hide geocoding-progress (hidden = true)
   - Show import-summary (hidden = false)
   - Build summary HTML:
     - Success message: "{successCount} colistier(s) ajoute(s) avec succes!"
     - If failures: warning with count and list of failed names
     - Hint for failed: "Ces colistiers peuvent etre ajoutes manuellement plus tard."
     - Final instruction: "Cliquez sur 'Terminer' pour afficher la carte."
7. Return true

Setup geocoding step trigger:
In setupPreviewStep() (or create new setupGeocodingTrigger function), add event listener for wz.btn.next:
- When wizard.current_step === 5 (after Validation step, going to Confirmation)
- Call runGeocodingStep() in setTimeout

IMPORTANT: The geocoding step should run automatically when entering step 7 (Confirmation). User does not trigger it manually - it starts as soon as they navigate to that step.
  </action>
  <verify>
Run dev server. Upload valid CSV with 3 test addresses. Navigate through wizard to Confirmation step. Should see:
1. Progress bar filling up
2. Status text updating per address
3. Final summary with success/failure counts
  </verify>
  <done>
Geocoding runs automatically on entering Confirmation step, shows progress bar and per-address status, displays final summary with success/failure breakdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update wizard completion to handle CSV import flow</name>
  <files>src/ui/wizard.js</files>
  <action>
Modify handleWizardComplete() function to handle both flows:

1. Original flow (commune selection only):
   - If selectedCommune exists AND validatedMembers is null/empty
   - Save commune config (existing behavior)
   - Close dialog

2. CSV import flow (commune + team members):
   - If selectedCommune exists AND validatedMembers has data
   - Save commune config (existing behavior)
   - Team members already saved to store during geocoding step
   - Close dialog
   - Trigger map refresh if needed (store events should handle this)

3. Edge case: No commune selected
   - Log error and return early
   - This shouldn't happen if wizard navigation is correct

The key insight: store.addTeamMember() is called during geocoding, so by the time handleWizardComplete() runs, all successfully geocoded members are already persisted. The completion handler just needs to save commune config and close.

Also update the wizard's Finish button context:
- The 'finish' label in Wizard config should be 'Terminer' (French for "Finish")
- Update the wizard init config: finish: 'Terminer'

Reset module state on wizard close:
Add to dialog close listener or handleWizardComplete():
```javascript
selectedFile = null;
validatedMembers = null;
```
  </action>
  <verify>
Run dev server. Complete full wizard flow with CSV import. After clicking Terminer:
1. Wizard dialog closes
2. Map displays with geocoded team members as markers
3. Side panel shows team members list
4. localStorage contains saved data (check in DevTools)
  </verify>
  <done>
Wizard completion saves commune config, closes dialog, team members appear on map and in side panel.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add progress indicator CSS styles</name>
  <files>src/style.css</files>
  <action>
Add CSS at end of file for geocoding progress UI:

/* Geocoding Progress Styles */

progress {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  margin: 12px 0;
  -webkit-appearance: none;
  appearance: none;
}

progress::-webkit-progress-bar {
  background: #e5e7eb;
  border-radius: 4px;
}

progress::-webkit-progress-value {
  background: #2563eb;
  border-radius: 4px;
}

progress::-moz-progress-bar {
  background: #2563eb;
  border-radius: 4px;
}

.status {
  font-size: 13px;
  color: #6b7280;
  min-height: 20px;
}

/* Import summary */
#import-summary {
  padding: 16px;
  background: #f0fdf4;
  border-radius: 8px;
  border: 1px solid #bbf7d0;
}

#import-summary .warning {
  margin-top: 12px;
}

.failed-list {
  max-height: 100px;
  overflow-y: auto;
  font-size: 13px;
  padding-left: 20px;
  margin: 8px 0;
}

.hint {
  font-size: 12px;
  color: #6b7280;
  font-style: italic;
  margin-top: 8px;
}
  </action>
  <verify>
Run dev server. Navigate to Confirmation step with valid CSV. Verify:
1. Progress bar has blue fill color
2. Status text is gray and readable
3. Summary box has green background
4. Failed list (if any) is scrollable
  </verify>
  <done>
Progress bar styled with project colors, summary box has success styling, failed items list is scrollable.
  </done>
</task>

</tasks>

<verification>
Complete end-to-end wizard flow:
1. Start dev server: `npm run dev`
2. Clear localStorage: `localStorage.clear()` in console, refresh
3. Complete commune selection (steps 1-3)
4. View CSV format explanation (step 4)
5. Upload CSV template file (step 5)
6. See validation preview (step 6) - should show 3 colistiers
7. Watch geocoding progress (step 7):
   - Progress bar fills
   - Status updates per address
   - Summary shows results
8. Click "Terminer"
9. Verify:
   - Wizard closes
   - Map shows commune boundary + team member markers
   - Side panel shows team members list
   - localStorage has data (check Application tab in DevTools)
10. Refresh page - data should persist (wizard should NOT show again)
</verification>

<success_criteria>
- Geocoding progress bar shows real-time progress
- Per-address status updates during geocoding
- Summary shows success count and any failures
- Wizard completion closes dialog and shows map
- Team members persist in localStorage
- Map displays with markers for geocoded addresses
</success_criteria>

<output>
After completion, create `.planning/phases/06-csv-import-wizard/06-03-SUMMARY.md`
</output>
