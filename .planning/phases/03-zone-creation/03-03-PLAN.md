---
phase: 03-zone-creation
plan: 03
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - src/map/zoneLayer.js
autonomous: true

must_haves:
  truths:
    - "User can edit existing zones (move vertices, adjust shape)"
    - "User can delete zones from the map"
    - "Edits and deletions persist across page refresh"
  artifacts:
    - path: "src/map/zoneLayer.js"
      provides: "Zone editing and deletion"
      contains: "pm:update"
  key_links:
    - from: "src/map/zoneLayer.js"
      to: "src/state/store.js"
      via: "store.updateZone on pm:update"
      pattern: "store\\.updateZone"
    - from: "src/map/zoneLayer.js"
      to: "src/state/store.js"
      via: "store.removeZone on pm:remove"
      pattern: "store\\.removeZone"
---

<objective>
Implement zone editing (vertex manipulation) and deletion.

Purpose: Enable users to modify and remove distribution zones after creation.
Output: Zones can be edited and deleted, changes persist.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-zone-creation/03-RESEARCH.md
@.planning/phases/03-zone-creation/03-02-SUMMARY.md

@src/map/zoneLayer.js
@src/state/store.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire pm:update event for zone editing</name>
  <files>src/map/zoneLayer.js</files>
  <action>
Add pm:update event handler in initZoneLayer (after pm:create handler):

```javascript
// Use pm:update instead of pm:edit to avoid duplicate saves during vertex drag
// pm:update fires once when editing completes, pm:edit fires continuously
map.on('pm:update', (e) => {
  const layer = e.layer;
  const zoneId = layer.options.zoneId;

  if (zoneId) {
    // Update zone geometry in store
    store.updateZone(zoneId, {
      geojson: layer.toGeoJSON()
    });
  }
});
```

Note from research: Use pm:update NOT pm:edit because:
- pm:edit fires on every vertex drag (dozens of times)
- pm:update fires once when edit mode exits
- Debounced save helps, but pm:update is cleaner

Also add layer-level event for individual polygon updates:
```javascript
// When loading zones, also bind pm:update on each layer
// This ensures edits on restored zones also save
```

Update loadZonesFromStore to bind edit event on each layer:
```javascript
onEachFeature: (feature, layer) => {
  layer.options.zoneId = zone.id;
  zoneGroup.addLayer(layer);
  layersByZoneId.set(zone.id, layer);
  layer.bindPopup(`<strong>${zone.name}</strong>`);

  // Bind edit event
  layer.on('pm:update', () => {
    store.updateZone(zone.id, {
      geojson: layer.toGeoJSON()
    });
  });
}
```
  </action>
  <verify>
   - `grep -n "pm:update" src/map/zoneLayer.js` shows event handler
   - `grep -n "store.updateZone" src/map/zoneLayer.js` shows store integration
  </verify>
  <done>
   - pm:update event wired to store.updateZone
   - Both map-level and layer-level events handled
   - Zone geometry updates saved to store
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pm:remove event for zone deletion</name>
  <files>src/map/zoneLayer.js</files>
  <action>
Add pm:remove event handler in initZoneLayer:

```javascript
map.on('pm:remove', (e) => {
  const layer = e.layer;
  const zoneId = layer.options.zoneId;

  if (zoneId) {
    // Remove from store
    store.removeZone(zoneId);

    // Clean up layer reference
    layersByZoneId.delete(zoneId);
  }
});
```

Notes:
- pm:remove fires when user uses Geoman's removal tool
- No confirmation dialog for MVP (per research, add later if needed)
- layersByZoneId cleanup prevents stale references
  </action>
  <verify>
   - `grep -n "pm:remove" src/map/zoneLayer.js` shows event handler
   - `grep -n "store.removeZone" src/map/zoneLayer.js` shows store integration
   - `grep -n "layersByZoneId.delete" src/map/zoneLayer.js` shows cleanup
  </verify>
  <done>
   - pm:remove event wired to store.removeZone
   - Layer reference cleaned up
   - Zone removed from localStorage
  </done>
</task>

<task type="auto">
  <name>Task 3: Test editing and deletion end-to-end</name>
  <files>none (testing only)</files>
  <action>
Run dev server and test complete editing/deletion flow:

1. Start dev server: `npm run dev`

2. Test zone editing:
   - Draw a zone named "Test Zone"
   - Click Edit button in Geoman toolbar (pencil icon)
   - Click on the zone to select it
   - Drag a vertex to new position
   - Click outside or toggle edit mode off
   - Open DevTools > Application > LocalStorage
   - Verify 'vivons_chapet_data' zones array shows updated coordinates
   - Refresh page
   - Verify zone has new shape after refresh

3. Test zone deletion:
   - Draw a new zone named "To Delete"
   - Click Removal button in Geoman toolbar (trash icon)
   - Click on "To Delete" zone
   - Verify zone disappears from map
   - Check localStorage - zone should be removed
   - Refresh page
   - Verify deleted zone stays deleted

4. Test edit persistence with multiple zones:
   - Draw Zone A and Zone B
   - Edit Zone A (move vertices)
   - Delete Zone B
   - Refresh page
   - Zone A should show with edits
   - Zone B should not appear

5. Verify no console errors throughout testing
  </action>
  <verify>
   - Zone edits persist across refresh
   - Zone deletions persist across refresh
   - No console errors during operations
   - LocalStorage reflects all changes
  </verify>
  <done>
   - User can edit zones (move vertices) - ZONE-02
   - User can delete zones - ZONE-03
   - Edits and deletions persist
   - Multiple zone operations work correctly
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify all Phase 3 success criteria:

1. **ZONE-01 (Draw)**: Click polygon button, click vertices, close polygon - zone created
2. **ZONE-02 (Edit)**: Click edit button, drag vertex, exit edit - geometry updated in localStorage
3. **ZONE-03 (Delete)**: Click removal button, click zone - zone removed from map and localStorage
4. **ZONE-04 (Name)**: Drawing zone prompts for name, popup shows name
5. **Persistence**: All operations survive page refresh

Test sequence:
1. Draw "Zone Nord" polygon
2. Draw "Zone Sud" polygon
3. Edit Zone Nord (move vertex)
4. Delete Zone Sud
5. Refresh page
6. Zone Nord (with edits) visible
7. Zone Sud gone
8. Draw new "Zone Est"
9. All operations work
</verification>

<success_criteria>
- User can edit existing zones (move vertices, adjust shape) - ZONE-02
- User can delete zones from the map - ZONE-03
- All changes persist across sessions
- No regressions in zone creation (ZONE-01, ZONE-04)
- No regressions in Phase 2 marker functionality
- Console free of errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-zone-creation/03-03-SUMMARY.md`
</output>
