---
phase: 03-zone-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/state/store.js
  - src/map/zoneLayer.js
  - src/main.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Geoman controls visible on map (polygon draw, edit, delete buttons)"
    - "Store can add, update, remove zones"
    - "Zones persist to localStorage"
  artifacts:
    - path: "src/map/zoneLayer.js"
      provides: "Zone layer management with Geoman"
      exports: ["initZoneLayer"]
    - path: "src/state/store.js"
      provides: "Zone CRUD methods"
      contains: "getZones"
  key_links:
    - from: "src/main.js"
      to: "src/map/zoneLayer.js"
      via: "initZoneLayer(map)"
      pattern: "initZoneLayer\\(map\\)"
    - from: "src/state/store.js"
      to: "src/data/storage.js"
      via: "zones included in persisted state"
      pattern: "zones.*\\[\\]"
---

<objective>
Set up Leaflet-Geoman and zone state management infrastructure.

Purpose: Create the foundation for drawing, editing, and persisting polygon zones.
Output: Geoman controls visible on map, store extended with zone CRUD, zones array persisted.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-zone-creation/03-RESEARCH.md

@src/state/store.js
@src/data/storage.js
@src/map/markerLayer.js
@src/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Leaflet-Geoman and extend store with zone CRUD</name>
  <files>package.json, src/state/store.js</files>
  <action>
1. Install Geoman:
   ```bash
   npm install @geoman-io/leaflet-geoman-free
   ```

2. Extend store.js state to include zones array:
   ```javascript
   this.state = {
     teamMembers: [],
     zones: []  // Add zones array
   };
   ```

3. Add zone CRUD methods following existing teamMember pattern:
   - `getZones()` - return copy of zones array
   - `addZone(zone)` - add zone with id, name, geojson, createdAt; publish 'zoneAdded'; debounced save
   - `updateZone(id, updates)` - find zone by id, apply updates, add updatedAt; publish 'zoneUpdated'; debounced save
   - `removeZone(id)` - remove zone by id; publish 'zoneRemoved'; debounced save

4. Add 'zonesLoaded' publish in _loadInitialState when zones array exists.

5. Update storage key constant to:
   ```javascript
   const STORAGE_KEY = 'vivons_chapet_data'; // Changed from 'vivons_chapet_team'
   ```
   Note: The state structure now includes both teamMembers and zones.
  </action>
  <verify>
   - `npm list @geoman-io/leaflet-geoman-free` shows version 2.19.2
   - `grep -n "zones:" src/state/store.js` shows zones in state
   - `grep -n "getZones\|addZone\|updateZone\|removeZone" src/state/store.js` shows all 4 methods
  </verify>
  <done>
   - Leaflet-Geoman installed
   - Store has zones array in state
   - Zone CRUD methods (getZones, addZone, updateZone, removeZone) exist
   - Zone events (zoneAdded, zoneUpdated, zoneRemoved, zonesLoaded) are published
  </done>
</task>

<task type="auto">
  <name>Task 2: Create zoneLayer.js with Geoman initialization</name>
  <files>src/map/zoneLayer.js</files>
  <action>
Create new file `src/map/zoneLayer.js`:

1. Import dependencies:
   ```javascript
   import L from 'leaflet';
   import '@geoman-io/leaflet-geoman-free';
   import '@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.css';
   import { store, subscribe } from '../state/store.js';
   ```

2. Module-level variables:
   ```javascript
   let map = null;
   let zoneGroup = null;
   const layersByZoneId = new Map();
   ```

3. Zone style constants:
   ```javascript
   const ZONE_STYLE = {
     color: '#ef4444',      // Red border
     weight: 2,
     fillColor: '#fca5a5',
     fillOpacity: 0.2
   };
   ```

4. Export `initZoneLayer(mapInstance)`:
   - Store map reference
   - Create FeatureGroup and add to map
   - Add Geoman controls with options:
     ```javascript
     map.pm.addControls({
       position: 'topleft',
       drawMarker: false,
       drawCircleMarker: false,
       drawPolyline: false,
       drawRectangle: false,
       drawCircle: false,
       drawPolygon: true,
       editMode: true,
       dragMode: false,
       cutPolygon: false,
       removalMode: true
     });
     ```
   - Set global options:
     ```javascript
     map.pm.setGlobalOptions({
       pathOptions: ZONE_STYLE,
       snappable: true,
       snapDistance: 20,
       allowSelfIntersection: false
     });
     ```
   - Return zoneGroup (for future reference if needed)

Note: Event handlers (pm:create, pm:edit, pm:remove) will be added in Plan 03-02.
  </action>
  <verify>
   - File exists: `ls src/map/zoneLayer.js`
   - Exports initZoneLayer: `grep -n "export.*initZoneLayer" src/map/zoneLayer.js`
   - Imports Geoman CSS: `grep -n "leaflet-geoman.css" src/map/zoneLayer.js`
  </verify>
  <done>
   - zoneLayer.js created with Geoman imports
   - initZoneLayer function exported
   - FeatureGroup created for zone management
   - Geoman controls configured (polygon only, edit mode, removal mode)
   - Self-intersection disabled
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire zoneLayer into main.js and verify controls</name>
  <files>src/main.js</files>
  <action>
1. Add import at top of main.js:
   ```javascript
   import { initZoneLayer } from './map/zoneLayer.js';
   ```

2. Add initialization after initMarkerLayer(map):
   ```javascript
   initZoneLayer(map);
   ```

3. Run dev server and verify:
   - `npm run dev`
   - Open browser, check for Geoman toolbar on left side of map
   - Should see polygon draw button and trash button
  </action>
  <verify>
   - `grep -n "initZoneLayer" src/main.js` shows import and call
   - `npm run dev` starts without errors
   - Browser shows Geoman controls on map (manual check)
  </verify>
  <done>
   - zoneLayer initialized in main.js
   - Dev server runs without errors
   - Geoman polygon and removal controls visible on map
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm list @geoman-io/leaflet-geoman-free` returns version info
2. `npm run dev` starts without console errors
3. Browser shows:
   - Map with existing markers functionality intact
   - Geoman toolbar with polygon draw button
   - Edit and delete controls
4. Click polygon button - cursor changes to crosshair mode
5. Store methods work: In browser console:
   ```javascript
   const { store } = await import('./src/state/store.js');
   store.addZone({ name: 'Test', geojson: {} });
   console.log(store.getZones()); // Shows zone
   ```
</verification>

<success_criteria>
- Leaflet-Geoman 2.19.2 installed
- Geoman controls visible on map
- Store has zone CRUD methods
- Zones array persists to localStorage (with teamMembers)
- Dev server runs without errors
- Existing marker functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/03-zone-creation/03-01-SUMMARY.md`
</output>
