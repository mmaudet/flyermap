---
phase: 03-zone-creation
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/map/zoneLayer.js
autonomous: true

must_haves:
  truths:
    - "User can draw polygon zones on the map by clicking vertices"
    - "User can name each zone"
    - "Zones persist across page refresh"
  artifacts:
    - path: "src/map/zoneLayer.js"
      provides: "Zone creation, naming, and persistence"
      contains: "pm:create"
  key_links:
    - from: "src/map/zoneLayer.js"
      to: "src/state/store.js"
      via: "store.addZone on pm:create"
      pattern: "store\\.addZone"
    - from: "src/map/zoneLayer.js"
      to: "localStorage"
      via: "zones loaded on init"
      pattern: "store\\.getZones\\(\\)"
---

<objective>
Implement zone drawing with naming and persistence.

Purpose: Enable users to draw polygon zones, name them, and have zones persist across sessions.
Output: Drawing zones works, prompts for name, zones reload after page refresh.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-zone-creation/03-RESEARCH.md
@.planning/phases/03-zone-creation/03-01-SUMMARY.md

@src/map/zoneLayer.js
@src/state/store.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire pm:create event with zone naming</name>
  <files>src/map/zoneLayer.js</files>
  <action>
Add to initZoneLayer function after Geoman controls setup:

1. Create ID generator helper:
   ```javascript
   function generateZoneId() {
     return 'zone_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
   }
   ```

2. Add pm:create event handler:
   ```javascript
   map.on('pm:create', (e) => {
     const layer = e.layer;

     // Only handle polygons
     if (e.shape !== 'Polygon') return;

     // Add to FeatureGroup
     zoneGroup.addLayer(layer);

     // Generate ID and default name
     const zoneId = generateZoneId();
     const defaultName = `Zone ${store.getZones().length + 1}`;

     // Store ID in layer options
     layer.options.zoneId = zoneId;

     // Prompt for name (browser prompt for MVP)
     const name = prompt('Nom de la zone:', defaultName);
     const finalName = (name && name.trim()) ? name.trim() : defaultName;

     // Apply style to ensure consistency
     layer.setStyle(ZONE_STYLE);

     // Save to store
     store.addZone({
       id: zoneId,
       name: finalName,
       geojson: layer.toGeoJSON()
     });

     // Bind popup with zone name
     layer.bindPopup(`<strong>${finalName}</strong>`);

     // Store layer reference
     layersByZoneId.set(zoneId, layer);
   });
   ```

Key points:
- Prompt appears immediately after drawing completes
- Default name increments based on zone count
- Layer stored in both FeatureGroup and Map for lookup
- GeoJSON includes geometry, store handles id/name
  </action>
  <verify>
   - `grep -n "pm:create" src/map/zoneLayer.js` shows event handler
   - `grep -n "store.addZone" src/map/zoneLayer.js` shows store integration
   - `grep -n "prompt" src/map/zoneLayer.js` shows naming prompt
  </verify>
  <done>
   - pm:create event wired to store.addZone
   - Prompt appears for zone name on creation
   - Default name follows "Zone N" pattern
   - Zone layer has popup with name
   - Layer reference stored in layersByZoneId Map
  </done>
</task>

<task type="auto">
  <name>Task 2: Load existing zones on initialization</name>
  <files>src/map/zoneLayer.js</files>
  <action>
1. Create loadZonesFromStore helper function:
   ```javascript
   function loadZonesFromStore() {
     const zones = store.getZones();

     zones.forEach(zone => {
       // Create layer from GeoJSON
       const geoJSONLayer = L.geoJSON(zone.geojson, {
         style: ZONE_STYLE,
         onEachFeature: (feature, layer) => {
           // Store zone ID in layer
           layer.options.zoneId = zone.id;

           // Add to FeatureGroup
           zoneGroup.addLayer(layer);

           // Store reference
           layersByZoneId.set(zone.id, layer);

           // Bind popup
           layer.bindPopup(`<strong>${zone.name}</strong>`);
         }
       });
     });
   }
   ```

2. Call loadZonesFromStore at end of initZoneLayer, after event handlers:
   ```javascript
   // Load existing zones
   loadZonesFromStore();
   ```

3. Subscribe to 'zonesLoaded' event for full reload scenarios:
   ```javascript
   subscribe('zonesLoaded', () => {
     // Clear existing layers
     zoneGroup.clearLayers();
     layersByZoneId.clear();
     // Reload from store
     loadZonesFromStore();
   });
   ```

Note: L.geoJSON creates layers from GeoJSON. The onEachFeature callback lets us set up each polygon with the correct zoneId reference.
  </action>
  <verify>
   - `grep -n "loadZonesFromStore" src/map/zoneLayer.js` shows function
   - `grep -n "store.getZones" src/map/zoneLayer.js` shows store read
   - `grep -n "zonesLoaded" src/map/zoneLayer.js` shows event subscription
  </verify>
  <done>
   - loadZonesFromStore function loads zones from store
   - Zones appear on map after page refresh
   - zonesLoaded event clears and reloads zones
   - Layer references restored in layersByZoneId Map
  </done>
</task>

<task type="auto">
  <name>Task 3: Test zone creation and persistence</name>
  <files>none (testing only)</files>
  <action>
Run dev server and test complete flow:

1. Start dev server: `npm run dev`

2. Test zone creation:
   - Click polygon draw button in Geoman toolbar
   - Click 4+ points on map to draw a polygon
   - Click first point or double-click to close polygon
   - Verify prompt appears for zone name
   - Enter "Zone Nord" and click OK
   - Verify polygon appears with red border
   - Click on polygon to verify popup shows "Zone Nord"

3. Test persistence:
   - Open browser DevTools > Application > LocalStorage
   - Find 'vivons_chapet_data' key
   - Verify zones array contains the zone with correct name and geojson
   - Refresh the page (F5)
   - Verify "Zone Nord" polygon still appears on map
   - Click polygon to verify popup still works

4. Test multiple zones:
   - Draw second zone
   - Default name should be "Zone 2"
   - Both zones visible after refresh

5. Verify team markers still work:
   - If any team members exist, they should still display
   - Import CSV should still work
  </action>
  <verify>
   - Zone drawing works end-to-end
   - Prompt appears for naming
   - Zones visible after page refresh
   - localStorage contains zones array
   - Team member markers unaffected
  </verify>
  <done>
   - User can draw polygon zones by clicking vertices
   - User can name zones via prompt
   - Zones persist across browser sessions
   - Multiple zones work correctly
   - Existing functionality (markers) unaffected
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Draw polygon zone on map - prompt appears
2. Enter zone name - polygon shows on map with popup
3. Check localStorage - zone saved with name and geojson
4. Refresh page - zone reappears
5. Draw second zone - both persist
6. Console has no errors
7. Team markers (if any) still display correctly
</verification>

<success_criteria>
- User can draw polygon zones by clicking vertices (ZONE-01)
- User can name each zone (ZONE-04)
- Zones persist across sessions (localStorage)
- Popup shows zone name on click
- Multiple zones supported
- No regressions in Phase 2 functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-zone-creation/03-02-SUMMARY.md`
</output>
